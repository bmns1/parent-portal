<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicon Valley Academy Parent Portal (beta)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-bottom: 2px solid #0d9488; /* teal-600 */
            color: #0d9488; /* teal-600 */
            background-color: #f0fdfa; /* teal-50 */
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        #mobile-menu { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="text-center p-8 bg-white rounded-lg shadow-lg">
            <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-24 w-auto mx-auto mb-4">
            <h1 class="text-3xl font-bold text-gray-800 mt-4">Silicon Valley Academy</h1>
            <p class="text-lg text-gray-600 mb-8">Parent Portal (beta)</p>
            <p class="text-lg text-gray-600 mb-8">Use your kids Google Classroom account to login. Having trouble? Forgot Password? Email: parent.portal@svaschool.org</p>
            <div id="google-signin-button-container" class="flex justify-center"></div>
            <p class="text-lg text-gray-600 mb-8">....</p>
            <p class="text-lg text-gray-600 mb-8"> New families will receive the login account by the first day of school!</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <i id="loading-icon" class="ph-spinner-gap text-6xl text-teal-600 mx-auto animate-spin"></i>
            <h2 id="loading-title" class="text-2xl font-semibold text-gray-700 mt-4">Loading Portal Data...</h2>
            <p id="loading-message" class="text-gray-500">Please wait a moment.</p>
        </div>
    </div>

    <!-- Main Portal Content (Initially Hidden) -->
    <div id="portal-container" class="hidden">
        <!-- Modal for QR Code -->
        <div id="qr-code-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Event Check-in QR Code</h3>
                    <div class="mt-2 px-7 py-3">
                        <div id="qrcode" class="mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-4">Have an admin scan this code when you arrive at the event to get credit for your hours.</p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-modal-btn" class="px-4 py-2 bg-teal-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-300">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="min-h-screen bg-gray-100">
            <!-- Header -->
            <header class="bg-white shadow-md">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <img src="https://raw.githubusercontent.com/bmns1/parent-portal/main/logo.png" alt="SVA Logo" class="h-12 w-auto">
                            </div>
                            <div class="ml-4">
                                <h1 class="text-2xl font-bold text-gray-800">Silicon Valley Academy</h1>
                                <p class="text-sm text-gray-500">Parent Portal (beta)</p>
                            </div>
                        </div>
                        <div class="hidden sm:flex items-center">
                            <div id="user-info-desktop" class="mr-4 text-right"></div>
                            <button onclick="signOut();" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Sign Out</button>
                        </div>
                        <div class="sm:hidden flex items-center">
                            <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                                <span class="sr-only">Open main menu</span>
                                <i id="menu-icon-open" class="ph-list text-2xl"></i>
                                <i id="menu-icon-close" class="ph-x text-2xl hidden"></i>
                            </button>
                        </div>
                    </div>
                </div>
                 <div class="sm:hidden" id="mobile-menu">
                    <div class="pt-4 pb-3 border-b border-gray-200">
                        <div id="user-info-mobile" class="px-5"></div>
                    </div>
                    <div id="main-nav-mobile" class="px-2 pt-2 pb-3 space-y-1"></div>
                    <div class="pt-4 pb-3 border-t border-gray-200">
                        <div class="px-2">
                             <button onclick="signOut();" class="w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Sign Out</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Navigation Tabs -->
            <nav class="hidden sm:block bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div id="main-nav" class="flex justify-center -mb-px">
                        <button class="tab-btn tab-active text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="dashboard"><i class="ph-house mr-2"></i> Student Dashboard</button>
                        <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="actions"><i class="ph-bell-ringing mr-2"></i> Actions</button>
                        <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="volunteering"><i class="ph-hands-clapping mr-2"></i> Volunteering</button>
                        <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="signups"><i class="ph-list-checks mr-2"></i> My Signups</button>
                        <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="pto"><i class="ph-users-three mr-2"></i> PTO</button>
                        <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="faq-forms"><i class="ph-link mr-2"></i> Resources, Newsletters and FAQs</button>
                        <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="calendar"><i class="ph-calendar mr-2"></i> Calendar</button>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                <div id="dashboard" class="tab-content tab-content-active">
                     <h2 class="text-3xl font-bold text-gray-800 mb-6">My Students</h2>
                    <div id="student-content-container" class="space-y-12"></div>
                </div>
                
                <div id="actions" class="tab-content">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Actions</h2>
                    <div id="actions-content-container"></div>
                </div>

                <div id="volunteering" class="tab-content">
                     <h2 class="text-2xl font-semibold text-gray-800 mb-6">Volunteering Opportunities</h2>
                    <div class="mb-6 bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Volunteering Objectives & Rules</h3>
                        <p class="text-gray-600 text-sm">
                            Our parent volunteer program is essential to the success of our school community. The primary objective is to foster a strong partnership between parents and the school, enriching our students' educational experience. We require each family to complete a set number of volunteer hours per school year, divided between two semesters. Please sign up for opportunities that match your interests and schedule. If you must withdraw from a commitment, please do so at least three weeks in advance to allow another parent to take the spot. Failure to show up for a signed-up event without prior cancellation will result in a penalty, increasing your total required hours. For safety reasons, we ask that you do not bring small children while volunteering. We recommend arranging childcare during your volunteer shift. Thank you for your dedication to our students and school!
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="filter-semester" class="block text-sm font-medium text-gray-700">Semester</label>
                                <select id="filter-semester" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="all">All</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-event" class="block text-sm font-medium text-gray-700">Filter by Event</label>
                                <select id="filter-event" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="all">All Events</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-time" class="block text-sm font-medium text-gray-700">Time of Day</label>
                                <select id="filter-time" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option>All</option>
                                    <option>Morning</option>
                                    <option>Afternoon</option>
                                    <option>Evening</option>
                                    <option>All Day</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-hours" class="block text-sm font-medium text-gray-700">Max Hours</label>
                                <select id="filter-hours" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="99">Any</option>
                                    <option value="2">Up to 2</option>
                                    <option value="4">Up to 4</option>
                                    <option value="8">Up to 8</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-location" class="block text-sm font-medium text-gray-700">Location</label>
                                <select id="filter-location" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option>All</option>
                                    <option>On-Campus</option>
                                    <option>Remote</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-sort" class="block text-sm font-medium text-gray-700">Sort By</label>
                                <select id="filter-sort" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                    <option value="default">Default</option>
                                    <option value="recent">Recently Added</option>
                                </select>
                            </div>
                        </div>
                    </div>
                     <div id="volunteering-list" class="space-y-6"><p>Loading volunteering opportunities...</p></div>
                </div>

                <div id="signups" class="tab-content">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">My Volunteer Hours</h2>
                    <div id="my-signups-content"></div>
                </div>

                <div id="pto" class="tab-content">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Parent-Teacher Organization (PTO)</h2>
                    <div class="bg-white p-8 rounded-lg shadow-sm space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold text-teal-700 mb-2">Building a Strong School Community Together</h3>
                            <p class="text-gray-600">As-salamu alaykum! The SVA Parent-Teacher Organization (PTO) warmly welcomes all new and returning families. We believe that a high level of parent participation is critical to the success of our students' education, tarbiyah, and development. The PTO is a formal, volunteer-based organization of parents, teachers, and staff working together to enhance the SVA student experience.</p>
                        </div>
                        <div class="border-t pt-6">
                            <h3 class="text-xl font-semibold text-teal-700 mb-2">Our Mission & Key Roles</h3>
                            <ul class="list-disc list-inside space-y-2 text-gray-600">
                                <li><strong>Organize Enriching Events:</strong> We plan and execute co-curricular events and activities like International Day, Book Fairs, Movie Nights, and the Hajj Simulation to enrich our children's education.</li>
                                <li><strong>Raise Funds:</strong> Through community efforts, we raise funds to support vital school programs, classroom needs, and new initiatives.</li>
                                <li><strong>Build Community:</strong> We strive to create a strong, collaborative, and supportive environment that connects parents, teachers, and staff.</li>
                                <li><strong>Shape the Educational Experience:</strong> The PTO provides a valuable opportunity for parents to have a voice and actively contribute to their children's journey at SVA.</li>
                            </ul>
                        </div>
                         <div class="border-t pt-6">
                            <h3 class="text-xl font-semibold text-teal-700 mb-2">Get Involved</h3>
                            <p class="text-gray-600 mb-4">Every parent and guardian at SVA is automatically a member of the PTO! We encourage you to get involved. You can sign up to be a committee member for a specific event or support year-long school programs.</p>
                            <div class="bg-teal-50 p-4 rounded-lg">
                                <h4 class="font-semibold">2025-26 PTO Volunteering Leads:</h4>
                                <ul class="list-disc list-inside mt-2">
                                    <li>Sara M.</li>
                                    <li>Rubeka A.</li>
                                    <li>Esraa El T.</li>
                                    <li>Ahmed S.</li>
                                </ul>
                                <p class="mt-4">Interested in becoming a PTO lead, help out, or have a question? To reach the PTO leadership, please email <a href="mailto:pto@svamail.com" class="text-teal-600 font-semibold hover:underline">pto@svamail.com</a>.</p>
                            </div>
                        </div>
                    </div>
                </div>


               <div id="faq-forms" class="tab-content">
                    <div class="flex border-b border-gray-200">
                        <button class="faq-forms-tab-btn tab-active px-6 py-3 text-sm font-medium" data-tab="faq-content">FAQ</button>
                        <button class="faq-forms-tab-btn px-6 py-3 text-sm font-medium text-gray-500" data-tab="forms-content">Forms</button>
                        <button class="faq-forms-tab-btn px-6 py-3 text-sm font-medium text-gray-500" data-tab="newsletters-content">Newsletters</button>
                        <button class="faq-forms-tab-btn px-6 py-3 text-sm font-medium text-gray-500" data-tab="quicklinks-content">Quick Links</button>
                    </div>
                    <div id="faq-content" class="faq-forms-tab-content mt-6"></div>
                    <div id="forms-content" class="faq-forms-tab-content mt-6 hidden"></div>
                    <div id="newsletters-content" class="faq-forms-tab-content mt-6 hidden"></div>
                    <div id="quicklinks-content" class="faq-forms-tab-content mt-6 hidden"></div>
                </div>
                
                <div id="calendar" class="tab-content">
                     <h2 class="text-2xl font-semibold text-gray-800 mb-6">School Calendar</h2>
                     <div class="bg-white rounded-lg shadow overflow-hidden">
                        <iframe src="https://calendar.google.com/calendar/embed?src=svaschool.org_us4ga4j1cfs27epj0f2dfegcl0%40group.calendar.google.com&ctz=America/Los_Angeles" style="border: 0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
                    </div>
                </div>
            </main>
            
            <footer class="bg-white mt-12">
                 <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-500"><p>&copy; 2025 BMNS. All Rights Reserved - (parent.portal@svaschool.org)</p></div>
            </footer>
        </div>
    </div>
    
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script>
        // --- CONFIGURATION ---
        //const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxVvYA3ivr1rYfDN-5EPUes4wvCu8a-OoeiZ7AIY4goS8aRKAnMeWYN68-8QVHT9CT9/exec';
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx3LGShhqFBG5Y2TocWHYYgg8Sp-mK2YbkZ2x6tWJwf6li0teEvIYYXa5zNxDKtV4U7/exec';
        const NEWSLETTER_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdZkNNppgbr_FdH2FOAztYpujc9A4URAsQIlWnADSypDlb5_KnCiVP3EImRK96jWK3Yg/exec';
        const CLIENT_ID = "14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com";
        let ID_TOKEN = null;
        let portalData = {};

        // --- GOOGLE SIGN-IN ---
        function handleCredentialResponse(response) {
            ID_TOKEN = response.credential;
            const profile = JSON.parse(atob(ID_TOKEN.split('.')[1]));
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            const userInfoHtml = `<div class="flex items-center"><img class="h-8 w-8 rounded-full" src="${profile.picture}" alt=""><div class="ml-3"><div class="text-base font-medium text-gray-800">${profile.name}</div><div class="text-sm font-medium text-gray-500">${profile.email}</div></div></div>`;
            document.getElementById('user-info-desktop').innerHTML = userInfoHtml;
            document.getElementById('user-info-mobile').innerHTML = userInfoHtml;
            fetchData(ID_TOKEN);
            fetchAndRenderResources();
            addEventListeners();
        }

        function signOut() {
            google.accounts.id.disableAutoSelect();
            window.location.reload();
        }
        
        // --- HELPER FUNCTIONS ---
        function decodeGrade(grade) {
            const gradeStr = String(grade).toUpperCase();
            if (gradeStr === 'P') return 'Pre-K';
            if (gradeStr === '0') return 'KG';
            return `Grade ${gradeStr}`;
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return !isNaN(date.getTime()) ? date.toLocaleDateString() : dateString;
        }
        function formatGoogleDate(date) { return date.toISOString().split('T')[0].replace(/-/g, ''); }
        function generateICalLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nURL:${document.location.href}\nDTSTART;VALUE=DATE:${formatGoogleDate(startDate)}\nDTEND;VALUE=DATE:${formatGoogleDate(endDate)}\nSUMMARY:${event.name || event.title}\nDESCRIPTION:Event: ${event.name || event.title}\nLOCATION:Silicon Valley Academy\nEND:VEVENT\nEND:VCALENDAR`;
            return `data:text/calendar;charset=utf-8,${encodeURIComponent(icsContent)}`;
        }
        function generateGoogleCalendarLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const baseUrl = 'https://www.google.com/calendar/render?action=TEMPLATE';
            const title = `&text=${encodeURIComponent(event.name || event.title)}`;
            const dates = `&dates=${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
            const details = `&details=${encodeURIComponent('For more details, visit the school portal.')}`;
            const location = `&location=${encodeURIComponent('Silicon Valley Academy')}`;
            return `${baseUrl}${title}${dates}${details}${location}`;
        }
        function switchToTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active'));
            document.querySelectorAll(`.tab-btn[data-tab="${tabName}"]`).forEach(b => b.classList.add('tab-active'));
            document.getElementById(tabName).classList.add('tab-content-active');
            const mobileMenu = document.getElementById('mobile-menu');
            if(mobileMenu.style.display === 'block'){
                mobileMenu.style.display = 'none';
                document.getElementById('menu-icon-open').classList.remove('hidden');
                document.getElementById('menu-icon-close').classList.add('hidden');
            }
        }

// =================================================== test

/**
        function openSecureFile(fileKey) {
            alert("Fetching secure document... Please wait.");
            
            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: 'getSecureFile', 
                    fileKey: fileKey, 
                    token: ID_TOKEN 
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success' && result.data) {
                    const byteCharacters = atob(result.data.data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const file = new Blob([byteArray], {type: result.data.mimeType});
                    const fileURL = URL.createObjectURL(file);
                    window.open(fileURL);
                } else {
                    throw new Error(result.error || 'Could not load file.');
                }
            })
            .catch(error => {
                console.error('Secure file fetch error:', error);
                alert(`An error occurred while fetching the document: ${error.message}`);
            });
        }
*/
        //==================================================================

        function switchToTabAndSubTab(mainTabId, subTabId) {
            switchToTab(mainTabId);
            document.querySelectorAll('.faq-forms-tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500');
            });
            const subTabButton = document.querySelector(`.faq-forms-tab-btn[data-tab="${subTabId}"]`);
            if (subTabButton) {
                subTabButton.classList.add('tab-active');
                subTabButton.classList.remove('text-gray-500');
            }
            document.querySelectorAll('.faq-forms-tab-content').forEach(content => content.classList.add('hidden'));
            const subTabContent = document.getElementById(subTabId);
            if (subTabContent) subTabContent.classList.remove('hidden');
        }


        

        // --- DATA FETCH & RENDER ---
        function fetchData(token) {
            fetch(`${WEB_APP_URL}?token=${token}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('portal-container').classList.remove('hidden');
                    if (data.status !== 'success' || !data.data) throw new Error(data.error || 'Invalid data from backend.');
                    portalData = data.data;
                    renderDashboard(portalData.students);
                    renderActionsTab(portalData.students);
                    populateEventFilter(portalData.allEvents);
                    applyAndRenderFilters(); 
                    renderMySignups(portalData.volunteerProgress);
                    renderMySignupsList(portalData.mySignups);
                    renderMobileMenu();
                    if (typeof phosphor !== 'undefined') phosphor.replace();
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) loadingOverlay.innerHTML = `<div class="text-center"><i class="ph-x-circle text-6xl text-red-500 mx-auto"></i><h2 class="text-2xl font-semibold text-gray-700 mt-4">Failed to Load Portal</h2><p class="text-gray-500">${error.message}</p></div>`;
                });
        }
/**
        function fetchAndRenderResources() {
            fetch(NEWSLETTER_WEB_APP_URL)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderNewsletters(data.data.newsletters);
                        renderQuickLinks(data.data.quickLinks);
                    } else { throw new Error(data.error); }
                })
                .catch(error => {
                    console.error('Resources Fetch Error:', error);
                    if (document.getElementById('newsletters-list')) document.getElementById('newsletters-list').innerHTML = '<p class="text-red-500">Could not load newsletters.</p>';
                    if (document.getElementById('quick-links-list')) document.getElementById('quick-links-list').innerHTML = '<p class="text-red-500">Could not load quick links.</p>';
                });
        }
    */    



        function fetchAndRenderResources() {
            //fetch(NEWSLETTER_WEB_APP_URL) ============================================
            fetch(`${NEWSLETTER_WEB_APP_URL}?token=${ID_TOKEN}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderFAQ(data.data.faq);
                        renderForms(data.data.forms);
                        renderNewsletters(data.data.newsletters);
                        renderQuickLinks(data.data.quickLinks);
                    } else { throw new Error(data.error); }
                })
                .catch(error => {
                    console.error('Resources Fetch Error:', error);
                    if (document.getElementById('newsletters-list')) document.getElementById('newsletters-list').innerHTML = '<p class="text-red-500">Could not load newsletters.</p>';
                    if (document.getElementById('quick-links-list')) document.getElementById('quick-links-list').innerHTML = '<p class="text-red-500">Could not load quick links.</p>';
                });
        }
        
        function renderFAQ(faqItems) {
            const container = document.getElementById('faq-content');
            if (!container) return;
            if (!faqItems || faqItems.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No FAQ items found.</p>';
                return;
            }
            container.innerHTML = faqItems.map(item => `
                <div class="mb-4">
                    <h4 class="font-bold text-gray-800">Q: ${item.question}</h4>
                    <p class="text-gray-600 mt-1">A: ${item.answer}</p>
                </div>
            `).join('');
        }

        function renderForms(forms) {
            const container = document.getElementById('forms-content');
            if (!container) return;
            if (!forms || forms.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No forms found.</p>';
                return;
            }
            container.innerHTML = forms.map(form => `
                <div class="mb-4 border-b pb-2">
                    <a href="${form.link}" target="_blank" class="text-teal-600 hover:underline font-semibold">${form.title}</a>
                    <p class="text-sm text-gray-600 mt-1">${form.description}</p>
                </div>
            `).join('');
        }

        function renderNewsletters(newsletters) {
            const container = document.getElementById('newsletters-content');
            if (!container) return;

            let listItems = '';
            if (!newsletters || newsletters.length === 0) {
                listItems = '<li><p class="text-gray-500">No newsletters found.</p></li>';
            } else {
                listItems = newsletters.map(n => 
                    `<li class="border-b pb-2"><a href="${n.link}" target="_blank" class="text-teal-600 hover:underline">${n.title}</a></li>`
                ).join('');
            }

            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Newsletters</h2>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <ul class="space-y-4">${listItems}</ul>
                </div>
            `;
        }

        function renderQuickLinks(links) {
            const container = document.getElementById('quicklinks-content');
            if (!container) return;

            let listItems = '';
            if (!links || links.length === 0) {
                listItems = '<li><p class="text-gray-500">No links found.</p></li>';
            } else {
                listItems = links.map(l => 
                    `<li class="border-b pb-2"><a href="${l.link}" target="_blank" class="text-teal-600 hover:underline">${l.title}</a></li>`
                ).join('');
            }

            container.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Quick Links</h2>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <ul class="space-y-4">${listItems}</ul>
                </div>
            `;
        }


function renderDashboard(students) {
            const contentContainer = document.getElementById('student-content-container');
            contentContainer.innerHTML = ''; 
            if (!students || students.length === 0) {
                contentContainer.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-sm"><p class="text-center text-gray-600">No students found for this parent account.</p></div>';
                return;
            }
            students.forEach(student => {
                if (!student || !student.studentName) {
                    contentContainer.innerHTML += `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert"><p class="font-bold">Data Issue</p><p>An incomplete student record was found. Please check your 'Students' Google Sheet for any blank rows and delete them.</p></div>`;
                    return;
                }
                const studentCard = document.createElement('div');
                let teachersHtml = (student.teachers && student.teachers.length > 0) ? student.teachers.map(t => `<li class="flex items-center justify-between border-t pt-4"><div class="flex items-center"><img class="h-10 w-10 rounded-full mr-4" src="${t.photoUrl}" alt="${t.teacherName}"><div><p class="font-semibold">${t.teacherName}</p><p class="text-sm text-gray-500">${t.role}</p></div></div><a href="mailto:${t.email}" class="text-teal-600 hover:underline text-sm">${t.email}</a></li>`).join('') : '<li class="text-gray-500">No teachers listed for this student.</li>';
                
                let eventsHtml = '';
                if (student.events && student.events.length > 0) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const upcomingEvents = student.events.filter(event => new Date(event.date) >= today);

                    const visibleEvents = upcomingEvents.slice(0, 4);
                    const hiddenEvents = upcomingEvents.slice(4);

                    eventsHtml = visibleEvents.map((event, index) => renderEventItem(event, student, index)).join('');
                    
                    if (hiddenEvents.length > 0) {
                        eventsHtml += `<div id="more-events-${student.uniqueStudentId}" class="hidden space-y-4 pt-4 border-t">`;
                        eventsHtml += hiddenEvents.map((event, index) => renderEventItem(event, student, index + 4)).join('');
                        eventsHtml += `</div>`;
                        eventsHtml += `<div class="border-t pt-4 mt-4"><button data-student-id="${student.uniqueStudentId}" class="show-more-events-btn text-teal-600 font-semibold w-full text-center hover:underline">Show More</button></div>`;
                    }
                } else {
                    eventsHtml = '<li><p class="text-gray-500">No upcoming events for this student.</p></li>';
                }

                const studentInitials = student.studentName.split(" ").map(n=>n[0]).join("");
                // studentCard.innerHTML = `<div class="bg-white rounded-lg shadow p-6 mb-4"><div class="flex items-center"><img class="h-16 w-16 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=${studentInitials}" alt="Student Photo"><div class="ml-4"><h3 class="text-2xl font-bold text-gray-900">${student.studentName}</h3><p class="text-gray-600">${decodeGrade(student.grade)} - Classroom ${student.classroom}</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Quick Actions</h4><button data-student-id="${student.uniqueStudentId}" class="report-absence-nav-btn inline-flex items-center bg-teal-100 text-teal-800 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200">Report an Absence for ${student.studentName}</button></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Teachers</h4><ul class="space-y-4">${teachersHtml}</ul></div></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Upcoming Events for ${student.studentName}</h4><ul class="space-y-4">${eventsHtml}</ul></div></div>`;
                //studentCard.innerHTML = `<div class="bg-white rounded-lg shadow p-6 mb-4"><div class="flex items-center"><img class="h-16 w-16 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=${studentInitials}" alt="Student Photo"><div class="ml-4"><h3 class="text-2xl font-bold text-gray-900">${student.studentName}</h3><p class="text-gray-600">${decodeGrade(student.grade)} - Classroom ${student.classroom}</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Quick Actions</h4><div class="flex flex-wrap gap-4"><button data-student-id="${student.uniqueStudentId}" class="report-absence-nav-btn inline-flex items-center bg-teal-100 text-teal-800 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200">Report Absence or Tardy for ${student.studentName}</button><button onclick="openSecureFile('student-handbook');" class="inline-flex items-center bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200">View Student Handbook (PDF)</button></div></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Teachers</h4><ul class="space-y-4">${teachersHtml}</ul></div></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Upcoming Events for ${student.studentName}</h4><ul class="space-y-4">${eventsHtml}</ul></div></div>`;
                //studentCard.innerHTML = `<div class="bg-white rounded-lg shadow p-6 mb-4"><div class="flex items-center"><img class="h-16 w-16 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=${studentInitials}" alt="Student Photo"><div class="ml-4"><h3 class="text-2xl font-bold text-gray-900">${student.studentName}</h3><p class="text-gray-600">${decodeGrade(student.grade)} - Classroom ${student.classroom}</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Quick Actions</h4><div class="flex flex-wrap gap-4"><button data-student-id="${student.uniqueStudentId}" class="report-absence-nav-btn inline-flex items-center bg-teal-100 text-teal-800 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200">Report Absence or Tardy for ${student.studentName}</button><button onclick="switchToTab('faq-forms');" class="inline-flex items-center bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200">View Student Handbook (PDF)</button></div></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Teachers</h4><ul class="space-y-4">${teachersHtml}</ul></div></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Upcoming Events for ${student.studentName}</h4><ul class="space-y-4">${eventsHtml}</ul></div></div>`;
                studentCard.innerHTML = `<div class="bg-white rounded-lg shadow p-6 mb-4"><div class="flex items-center"><img class="h-16 w-16 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=${studentInitials}" alt="Student Photo"><div class="ml-4"><h3 class="text-2xl font-bold text-gray-900">${student.studentName}</h3><p class="text-gray-600">${decodeGrade(student.grade)} - Classroom ${student.classroom}</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Quick Actions</h4><div class="flex flex-wrap gap-4"><button data-student-id="${student.uniqueStudentId}" class="report-absence-nav-btn inline-flex items-center bg-teal-100 text-teal-800 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200">Report Absence or Tardy for ${student.studentName}</button><button onclick="switchToTabAndSubTab('faq-forms', 'quicklinks-content');" class="inline-flex items-center bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200">View Student Handbook (PDF)</button></div></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Teachers</h4><ul class="space-y-4">${teachersHtml}</ul></div></div><div class="bg-white p-6 rounded-lg shadow"><h4 class="font-semibold text-lg text-gray-700 mb-4">Upcoming Events for ${student.studentName}</h4><ul class="space-y-4">${eventsHtml}</ul></div></div>`;

                contentContainer.appendChild(studentCard);
            });
        }

       // function renderEventItem(event, student, index) {
      //      const volunteerStatusColor = event.totalSignedUp >= event.totalNeeded ? 'text-green-600' : 'text-red-600';
      //      const volunteerText = (event.totalNeeded > 0) ? `<p class="text-xs font-semibold ${volunteerStatusColor}">Volunteers: ${event.totalSignedUp} of ${event.totalNeeded}</p>` : '';
       //     return `<li class="border-t pt-4 flex justify-between items-center"><div><p class="font-semibold">${event.name}</p><p class="text-sm text-gray-500">${formatDate(event.date)}</p>${volunteerText}</div><div class="flex flex-col space-y-2 items-end"><button type="button" class="volunteer-for-event-btn w-full text-sm bg-teal-100 text-teal-800 font-semibold py-1 px-3 rounded-lg hover:bg-teal-200" data-event-id="${event.id}">Volunteer</button><div class="relative inline-block text-left w-full"><button type="button" class="add-to-calendar-btn w-full inline-flex items-center justify-center rounded-md border border-gray-300 shadow-sm px-3 py-1 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none" data-event-name="${event.name}" data-event-date="${event.date}"><i class="ph-plus-circle mr-2"></i> Add</button><div class="event-dropdown origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10"><div class="py-1"><a href="#" class="google-cal-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Google Calendar</a><a href="#" class="ical-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">iCal/Outlook</a></div></div></div></div></li>`;
      //  }

        function renderEventItem(event, student, index) {
            const volunteerStatusColor = event.totalSignedUp >= event.totalNeeded ? 'text-green-600' : 'text-red-600';
            const volunteerText = (event.totalNeeded > 0) ? `<p class="text-xs font-semibold ${volunteerStatusColor}">Volunteers: ${event.totalSignedUp} of ${event.totalNeeded}</p>` : '';
            const volunteerButtonHtml = (event.totalNeeded > event.totalSignedUp) ? `<button type="button" class="volunteer-for-event-btn w-full text-sm bg-teal-100 text-teal-800 font-semibold py-1 px-3 rounded-lg hover:bg-teal-200" data-event-id="${event.id}">Volunteer</button>` : '';

            return `<li class="flex justify-between items-center"><div><p class="font-semibold">${event.name}</p><p class="text-sm text-gray-500">${formatDate(event.date)}</p>${volunteerText}</div><div class="flex flex-col space-y-2 items-end">${volunteerButtonHtml}<div class="relative inline-block text-left w-full"><button type="button" class="add-to-calendar-btn w-full inline-flex items-center justify-center rounded-md border border-gray-300 shadow-sm px-3 py-1 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none" data-event-name="${event.name}" data-event-date="${event.date}"><i class="ph-plus-circle mr-2"></i> Add</button><div class="event-dropdown origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10"><div class="py-1"><a href="#" class="google-cal-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Google Calendar</a><a href="#" class="ical-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">iCal/Outlook</a></div></div></div></div></li>`;
        }

        
        function renderMobileMenu() {
            const desktopNav = document.getElementById('main-nav');
            const mobileNavContainer = document.getElementById('main-nav-mobile');
            mobileNavContainer.innerHTML = "";
            desktopNav.querySelectorAll('.tab-btn').forEach(button => {
                const newBtn = button.cloneNode(true);
                newBtn.classList.remove('py-4', 'px-6');
                newBtn.classList.add('block', 'px-3', 'py-2', 'rounded-md', 'text-base', 'font-medium');
                mobileNavContainer.appendChild(newBtn);
            });
        }

        function renderActionsTab(students) {
            const container = document.getElementById('actions-content-container');
            if (!students || students.length === 0) {
                container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow"><p>No students found. Cannot report an absence.</p></div>`;
                return;
            }
            const studentOptions = students.map(s => `<option value="${s.uniqueStudentId}">${s.studentName}</option>`).join('');
            container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow max-w-2xl mx-auto"><h3 class="font-semibold text-lg text-gray-700 mb-4">Report Absence or Tardy</h3><div class="mb-4"><label class="block text-sm font-medium text-gray-700">Student</label><select id="student-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${studentOptions}</select></div><div class="mb-4"><fieldset><legend class="text-sm font-medium text-gray-700">Report Type</legend><div class="mt-2 flex space-x-4"><label class="inline-flex items-center"><input type="radio" class="form-radio" name="report-type" value="absent" checked> <span class="ml-2">Absence</span></label><label class="inline-flex items-center"><input type="radio" class="form-radio" name="report-type" value="tardy"> <span class="ml-2">Tardy</span></label></div></fieldset></div><div id="absence-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="absence-start" class="block text-sm font-medium text-gray-700">Absence Start Date</label><input type="date" id="absence-start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label for="absence-end" class="block text-sm font-medium text-gray-700">Absence End Date</label><input type="date" id="absence-end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div><div id="tardy-fields" class="grid-cols-1 md:grid-cols-2 gap-4 mb-4" style="display: none;"><div><label for="tardy-start-time" class="block text-sm font-medium text-gray-700">Expected Arrival</label><input type="time" id="tardy-start-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label for="tardy-end-time" class="block text-sm font-medium text-gray-700"> Date</label><input type="date" id="tardy-end-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div><div class="mb-4"><label for="absence-reason" class="block text-sm font-medium text-gray-700">Reason</label><select id="absence-reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option>Sick</option><option>Travel</option><option>Appointment</option><option>Other</option></select></div><div id="other-reason-container" class="mb-4" style="display: none;"><label for="other-reason-text" class="block text-sm font-medium text-gray-700">Please specify:</label><textarea id="other-reason-text" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div><div class="mb-4"><label for="absence-comments" class="block text-sm font-medium text-gray-700">Optional Comments</label><textarea id="absence-comments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div><button id="send-notification-btn" class="inline-flex items-center bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Send Notification</button></div>`;
        }
/**
        function renderVolunteering(opportunities) {
            const list = document.getElementById('volunteering-list');
            list.innerHTML = '';
            if (!opportunities || opportunities.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 bg-white p-6 rounded-lg shadow">No volunteering opportunities match your current filters.</div>';
                return;
            }
            opportunities.forEach(opp => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow transition hover:shadow-lg';
                //card.innerHTML = `<div class="flex flex-col md:flex-row justify-between"><div><h3 class="text-xl font-bold text-gray-900">${opp.title}</h3><p class="mt-2 text-gray-600">${opp.description}</p><div class="mt-4 flex flex-col sm:flex-row sm:items-center text-sm text-gray-500 space-y-2 sm:space-y-0 sm:space-x-4"><span><i class="ph-calendar-blank mr-1"></i> ${formatDate(opp.date)}</span><span><i class="ph-clock mr-1"></i> ${opp.time}</span><span><i class="ph-map-pin mr-1"></i> ${opp.location}</span><span><i class="ph-star mr-1"></i> Semester: ${opp.semester}</span></div></div><div class="mt-4 md:mt-0 md:ml-6 flex-shrink-0 text-right"><p class="text-sm text-gray-600 mb-2" id="spots-${opp.id}">${opp.signedUp} of ${opp.needed} spots filled</p><button data-id="${opp.id}" class="signup-btn w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition">Sign Up</button></div></div>`;
                //card.innerHTML = `<div class="flex flex-col md:flex-row justify-between"><div><h3 class="text-xl font-bold text-gray-900">${opp.title}</h3><p class="mt-2 text-gray-600">${opp.description}</p><div class="mt-4 flex flex-col sm:flex-row sm:items-center text-sm text-gray-500 space-y-2 sm:space-y-0 sm:space-x-4"><span><i class="ph-calendar-blank mr-1"></i> ${formatDate(opp.date)}</span><span><i class="ph-clock mr-1"></i> ${opp.time}</span><span><i class="ph-map-pin mr-1"></i> ${opp.location}</span><span><i class="ph-star mr-1"></i> Semester: ${opp.semester}</span></div></div><div class="mt-4 md:mt-0 md:ml-6 flex-shrink-0 text-right"><p class="text-sm text-gray-600 mb-2" id="spots-${opp.id}">${opp.signedUp} of ${opp.needed} spots filled</p><button data-id="${opp.id}" class="signup-btn w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition">Sign Up</button></div></div>`;
                card.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
        <div class="md:col-span-2">
            <h3 class="text-xl font-bold text-gray-900">${opp.title}</h3>
            <p class="mt-2 text-gray-600">${opp.description}</p>
            <div class="mt-4 flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-500">
                <span class="flex items-center"><i class="ph-calendar-blank mr-1"></i> ${formatDate(opp.date)}</span>
                <span class="flex items-center"><i class="ph-clock mr-1"></i> ${opp.time}</span>
                <span class="flex items-center"><i class="ph-map-pin mr-1"></i> ${opp.location}</span>
                <span class="flex items-center"><i class="ph-star mr-1"></i> Semester: ${opp.semester}</span>
            </div>
        </div>
        <div class="text-center md:text-right">
            <div class="mb-3">
                <span class="text-lg font-bold text-teal-600">${opp.signedUp}</span>
                <span class="text-sm text-gray-500">/ ${opp.needed} spots filled</span>
            </div>
            <button data-id="${opp.id}" class="signup-btn inline-flex items-center justify-center w-full md:w-auto bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                <i class="ph-paper-plane-tilt mr-2"></i>
                Sign Up
            </button>
        </div>
    </div>`;
                
                
                
                
                list.appendChild(card);
            


            
            });
        }
       


        function renderVolunteering(opportunities) {
    const list = document.getElementById('volunteering-list');
    list.innerHTML = '';
    if (!opportunities || opportunities.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 bg-white p-6 rounded-lg shadow">No volunteering opportunities match your current filters.</div>';
        return;
    }

    // Group opportunities by title and event
    const groupedOpportunities = opportunities.reduce((acc, opp) => {
        const key = `${opp.eventid}-${opp.title}`;
        if (!acc[key]) {
            acc[key] = {
                ...opp,
                timeSlots: []
            };
        }
        acc[key].timeSlots.push(opp);
        return acc;
    }, {});

    Object.values(groupedOpportunities).forEach(group => {
        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-lg shadow transition hover:shadow-lg';

        const timeSlotsHtml = group.timeSlots.map(slot => `
            <div class="flex justify-between items-center border-t border-gray-200 py-3">
                <div>
                    <p class="font-semibold text-gray-800">${slot.time}</p>
                    <p class="text-sm text-gray-500">${slot.signedUp} of ${slot.needed} spots filled</p>
                </div>
                <button data-id="${slot.id}" class="signup-btn inline-flex items-center justify-center bg-teal-100 text-teal-800 font-bold py-2 px-4 rounded-lg hover:bg-teal-200 transition duration-300">
                    Sign Up
                </button>
            </div>
        `).join('');

        card.innerHTML = `
            <div>
                <h3 class="text-xl font-bold text-gray-900">${group.title}</h3>
                <p class="mt-2 text-gray-600">${group.description}</p>
                <div class="mt-4 flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-500">
                    <span class="flex items-center"><i class="ph-calendar-blank mr-1"></i> ${formatDate(group.date)}</span>
                    <span class="flex items-center"><i class="ph-map-pin mr-1"></i> ${group.location}</span>
                    <span class="flex items-center"><i class="ph-star mr-1"></i> Semester: ${group.semester}</span>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-700 mb-2">Available Time Slots:</h4>
                    <div class="space-y-2">
                        ${timeSlotsHtml}
                    </div>
                </div>
            </div>`;
        list.appendChild(card);
    });
}

 


        function renderVolunteering(opportunities) {
    const list = document.getElementById('volunteering-list');
    list.innerHTML = '';
    if (!opportunities || opportunities.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 bg-white p-6 rounded-lg shadow">No volunteering opportunities match your current filters.</div>';
        return;
    }

    const groupedByEvent = opportunities.reduce((acc, opp) => {
        const eventName = portalData.allEvents.find(e => e.id === opp.eventid)?.name || 'General Opportunities';
        if (!acc[eventName]) {
            acc[eventName] = [];
        }
        acc[eventName].push(opp);
        return acc;
    }, {});

    Object.keys(groupedByEvent).forEach((eventName, index) => {
        const opportunitiesInEvent = groupedByEvent[eventName];
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-sm';

        const timeSlotsHtml = opportunitiesInEvent.map(slot => `
            <div class="flex justify-between items-center border-t border-gray-200 py-3 px-6">
                <div>
                    <p class="font-semibold text-gray-800">${slot.title} - ${slot.time}</p>
                    <p class="text-sm text-gray-500">${slot.signedUp} of ${slot.needed} spots filled</p>
                </div>
                <button data-id="${slot.id}" class="signup-btn inline-flex items-center justify-center bg-teal-100 text-teal-800 font-bold py-2 px-4 rounded-lg hover:bg-teal-200 transition duration-300">
                    Sign Up
                </button>
            </div>
        `).join('');

        card.innerHTML = `
            <div class="p-4 border-b border-gray-200 cursor-pointer flex justify-between items-center volunteer-card-header" data-target="event-group-${index}">
                <h3 class="text-xl font-bold text-gray-900">${eventName}</h3>
                <i class="ph-caret-down text-2xl transition-transform"></i>
            </div>
            <div id="event-group-${index}" class="hidden">
                ${timeSlotsHtml}
            </div>
        `;
        list.appendChild(card);
    });
}
*/


        function renderVolunteering(opportunities) {
    const list = document.getElementById('volunteering-list');
    list.innerHTML = '';
    if (!opportunities || opportunities.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 bg-white p-6 rounded-lg shadow">No volunteering opportunities match your current filters.</div>';
        return;
    }

    // Step 1: Group all opportunities by their Event Name
    const groupedByEvent = opportunities.reduce((acc, opp) => {
        const eventName = portalData.allEvents.find(e => e.id === opp.eventid)?.name || 'General Opportunities';
        if (!acc[eventName]) {
            acc[eventName] = [];
        }
        acc[eventName].push(opp);
        return acc;
    }, {});

    // Step 2: For each event, render a collapsible card
    Object.keys(groupedByEvent).forEach((eventName, index) => {
        const opportunitiesInEvent = groupedByEvent[eventName];
        
        // Step 3: Within each event, group opportunities by their Title
        const groupedByTitle = opportunitiesInEvent.reduce((acc, opp) => {
            const key = opp.title;
            if (!acc[key]) {
                acc[key] = { ...opp, timeSlots: [] };
            }
            acc[key].timeSlots.push(opp);
            return acc;
        }, {});

        const eventContentHtml = Object.values(groupedByTitle).map(group => {
            const timeSlotsHtml = group.timeSlots.map(slot => `
                <div class="flex justify-between items-center border-t border-gray-200 py-3">
                    <div>
                        <p class="font-semibold text-gray-800">${slot.time}</p>
                        <p class="text-sm text-gray-500">${slot.signedUp} of ${slot.needed} spots filled</p>
                    </div>
                    <button data-id="${slot.id}" class="signup-btn inline-flex items-center justify-center bg-teal-100 text-teal-800 font-bold py-2 px-4 rounded-lg hover:bg-teal-200 transition duration-300">
                        Sign Up
                    </button>
                </div>
            `).join('');

            return `
                <div class="px-6 py-4 border-t">
                    <h4 class="text-lg font-bold text-gray-800">${group.title}</h4>
                    <p class="mt-1 text-sm text-gray-600">${group.description}</p>
                    <div class="mt-3 flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500">
                        <span class="flex items-center"><i class="ph-calendar-blank mr-1"></i> ${formatDate(group.date)}</span>
                        <span class="flex items-center"><i class="ph-map-pin mr-1"></i> ${group.location}</span>
                        <span class="flex items-center"><i class="ph-star mr-1"></i> Semester: ${group.semester}</span>
                    </div>
                    <div class="mt-3">
                        <h5 class="font-semibold text-gray-700 mb-1 text-sm">Available Time Slots:</h5>
                        <div class="space-y-1">
                            ${timeSlotsHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-sm';
        card.innerHTML = `
            <div class="p-4 border-b border-gray-200 cursor-pointer flex justify-between items-center volunteer-card-header" data-target="event-group-${index}">
                <h3 class="text-xl font-bold text-gray-900">${eventName}</h3>
                <i class="ph-caret-down text-2xl transition-transform"></i>
            </div>
            <div id="event-group-${index}" class="hidden">
                ${eventContentHtml}
            </div>
        `;
        list.appendChild(card);
    });
}

/**
        
        function applyAndRenderFilters() {
            if (!portalData.volunteering || !document.getElementById('filter-time')) {
                if(portalData.volunteering) renderVolunteering(portalData.volunteering);
                return;
            }
            let filteredOpportunities = [...portalData.volunteering];
            const eventFilterValue = document.getElementById('filter-event').value;
            const semesterFilter = document.getElementById('filter-semester').value;
            const timeFilter = document.getElementById('filter-time').value;
            const hoursFilter = parseInt(document.getElementById('filter-hours').value, 10);
            const locationFilter = document.getElementById('filter-location').value;
            const sortFilter = document.getElementById('filter-sort').value;
            if (eventFilterValue !== 'all') filteredOpportunities = filteredOpportunities.filter(opp => opp.eventid === eventFilterValue);
            if (semesterFilter !== 'all') filteredOpportunities = filteredOpportunities.filter(opp => String(opp.semester) === semesterFilter);
            if (timeFilter !== 'All') filteredOpportunities = filteredOpportunities.filter(opp => opp.timeOfDay === timeFilter);
            if (hoursFilter !== 99) filteredOpportunities = filteredOpportunities.filter(opp => opp.hours <= hoursFilter);
            if (locationFilter !== 'All') filteredOpportunities = filteredOpportunities.filter(opp => opp.locationType === locationFilter);
            if (sortFilter === 'recent') filteredOpportunities.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            renderVolunteering(filteredOpportunities);
        }

        */

        //====================================================================== test
        function applyAndRenderFilters() {
            if (!portalData.volunteering || !document.getElementById('filter-time')) {
                if(portalData.volunteering) renderVolunteering(portalData.volunteering);
                return;
            }
            const signedUpOppIds = portalData.mySignups.filter(signup => signup.status !== 'Withdrawn').map(signup => signup.opportunityId);
            let filteredOpportunities = [...portalData.volunteering];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            filteredOpportunities = filteredOpportunities.filter(opp => new Date(opp.date) >= today);

            const eventFilterValue = document.getElementById('filter-event').value;
            const semesterFilter = document.getElementById('filter-semester').value;
            const timeFilter = document.getElementById('filter-time').value;
            const hoursFilter = parseInt(document.getElementById('filter-hours').value, 10);
            const locationFilter = document.getElementById('filter-location').value;
            const sortFilter = document.getElementById('filter-sort').value;
            if (eventFilterValue !== 'all') filteredOpportunities = filteredOpportunities.filter(opp => opp.eventid === eventFilterValue);
            if (semesterFilter !== 'all') filteredOpportunities = filteredOpportunities.filter(opp => String(opp.semester) === semesterFilter);
            if (timeFilter !== 'All') filteredOpportunities = filteredOpportunities.filter(opp => opp.timeOfDay === timeFilter);
            if (hoursFilter !== 99) filteredOpportunities = filteredOpportunities.filter(opp => opp.hours <= hoursFilter);
            if (locationFilter !== 'All') filteredOpportunities = filteredOpportunities.filter(opp => opp.locationType === locationFilter);
            filteredOpportunities = filteredOpportunities.filter(opp => {
                const isFull = opp.signedUp >= opp.needed;
                const isSignedUp = signedUpOppIds.includes(opp.id);
                return !isFull && !isSignedUp;
            });
            if (sortFilter === 'recent') filteredOpportunities.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            renderVolunteering(filteredOpportunities);
        }


        //=========================================================================

        function populateEventFilter(events) {
            const eventFilter = document.getElementById('filter-event');
            if (!eventFilter || !events) return;
            const uniqueEvents = new Map();
            events.forEach(event => { if (event.id && !uniqueEvents.has(event.id)) uniqueEvents.set(event.id, event.name); });
            while (eventFilter.options.length > 1) eventFilter.remove(1);
            uniqueEvents.forEach((name, id) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                eventFilter.appendChild(option);
            });
        }

        function renderMySignups(progress) {
            const container = document.getElementById('my-signups-content');
            container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow mb-8"><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 class="text-lg font-semibold text-gray-800">Semester 1 Progress</h3><div class="mt-4"><div class="flex justify-between mb-1"><span class="text-base font-medium text-teal-700">Completed Hours</span><span class="text-sm font-medium text-teal-700" id="progress-text-s1"></span></div><div class="w-full bg-gray-200 rounded-full h-4 relative"><div id="progress-bar-s1-inprogress" class="bg-orange-400 h-4 rounded-full" style="width: 0%"></div><div id="progress-bar-s1-completed" class="bg-teal-600 h-4 rounded-full absolute top-0 left-0" style="width: 0%"></div></div><div class="flex justify-between text-xs text-gray-500 mt-2"><span id="in-progress-text-s1"></span><span id="penalty-text-s1" class="text-red-600 font-semibold"></span></div></div></div><div><h3 class="text-lg font-semibold text-gray-800">Semester 2 Progress</h3><div class="mt-4"><div class="flex justify-between mb-1"><span class="text-base font-medium text-teal-700">Completed Hours</span><span class="text-sm font-medium text-teal-700" id="progress-text-s2"></span></div><div class="w-full bg-gray-200 rounded-full h-4 relative"><div id="progress-bar-s2-inprogress" class="bg-orange-400 h-4 rounded-full" style="width: 0%"></div><div id="progress-bar-s2-completed" class="bg-teal-600 h-4 rounded-full absolute top-0 left-0" style="width: 0%"></div></div><div class="flex justify-between text-xs text-gray-500 mt-2"><span id="in-progress-text-s2"></span><span id="penalty-text-s2" class="text-red-600 font-semibold"></span></div></div></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 class="text-xl font-semibold text-gray-700 mb-4">Upcoming Signups (In Progress)</h3><p class="text-sm text-gray-600 mb-4">You may withdraw up to 3 weeks (21 days) before the event.</p><div id="upcoming-signups-list" class="space-y-4"></div></div><div><h3 class="text-xl font-semibold text-gray-700 mb-4">Completed & Past Signups</h3><div id="completed-signups-list" class="space-y-4"></div></div></div>`;
            if (progress) {
                const s1 = progress.semester1;
                const s1_req = s1.totalRequired || 0;
                const s1_completed_p = s1_req > 0 ? (s1.completed / s1_req) * 100 : 0;
                const s1_inprogress_p = s1_req > 0 ? (s1.inProgress / s1_req) * 100 : 0;
                document.getElementById('progress-bar-s1-completed').style.width = `${Math.min(s1_completed_p, 100)}%`;
                document.getElementById('progress-bar-s1-inprogress').style.width = `${Math.min(s1_completed_p + s1_inprogress_p, 100)}%`;
                document.getElementById('progress-text-s1').textContent = `${s1.completed} of ${s1.baseRequired} hours`;
                document.getElementById('in-progress-text-s1').textContent = `${s1.inProgress || 0} hours in progress`;
                document.getElementById('penalty-text-s1').textContent = s1.penalty > 0 ? `+ ${s1.penalty} penalty hours` : '';
                const s2 = progress.semester2;
                const s2_req = s2.totalRequired || 0;
                const s2_completed_p = s2_req > 0 ? (s2.completed / s2_req) * 100 : 0;
                const s2_inprogress_p = s2_req > 0 ? (s2.inProgress / s2_req) * 100 : 0;
                document.getElementById('progress-bar-s2-completed').style.width = `${Math.min(s2_completed_p, 100)}%`;
                document.getElementById('progress-bar-s2-inprogress').style.width = `${Math.min(s2_completed_p + s2_inprogress_p, 100)}%`;
                document.getElementById('progress-text-s2').textContent = `${s2.completed} of ${s2.baseRequired} hours`;
                document.getElementById('in-progress-text-s2').textContent = `${s2.inProgress || 0} hours in progress`;
                document.getElementById('penalty-text-s2').textContent = s2.penalty > 0 ? `+ ${s2.penalty} penalty hours` : '';
            }
        }

        function renderMySignupsList(signups) {
            const upcomingList = document.getElementById('upcoming-signups-list');
            const completedList = document.getElementById('completed-signups-list');
            upcomingList.innerHTML = '';
            completedList.innerHTML = '';
            const upcomingSignups = signups.filter(s => s.status === 'In Progress');
            const pastSignups = signups.filter(s => s.status === 'Completed' || s.status === 'Penalty' || s.status === 'Withdrawn');
            if (upcomingSignups.length === 0) upcomingList.innerHTML = '<div class="bg-white p-4 rounded-lg shadow-sm text-gray-500">No upcoming volunteer signups.</div>';
            else {
                upcomingSignups.forEach((signup, index) => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-6 rounded-lg shadow-sm';
                    const eventDate = new Date(signup.date);
                    const daysUntilEvent = (eventDate - new Date()) / (1000 * 60 * 60 * 24);
                    let withdrawButtonHtml = daysUntilEvent > 21 ? `<button data-signup-id="${signup.signupId}" class="withdraw-btn w-full text-sm bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition">Withdraw</button>` : `<button class="w-full text-sm bg-gray-200 text-gray-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed" disabled>Withdrawal period has passed</button>`;
                    const qrButtonHtml = `<button data-signup-id="${signup.signupId}" class="show-qr-btn w-full text-sm bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition">Show Check-in Code</button>`;
                    const calendarButtonHtml = `<div class="relative"><button type="button" class="add-to-calendar-btn w-full inline-flex items-center justify-center rounded-md border border-gray-300 shadow-sm px-3 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none" data-event-name="${signup.title}" data-event-date="${signup.date}"><i class="ph-plus-circle mr-2"></i> Add</button><div class="event-dropdown origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10"><div class="py-1"><a href="#" class="google-cal-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Google Calendar</a><a href="#" class="ical-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">iCal/Outlook</a></div></div></div>`;
                    item.innerHTML = `<div class="flex flex-col sm:flex-row justify-between"><div class="flex-grow"><h4 class="text-lg font-bold text-gray-900">${signup.title}</h4><div class="mt-4 sm:mt-0 sm:ml-6 flex-shrink-0 flex flex-col space-y-2 w-full sm:w-48">${qrButtonHtml}${withdrawButtonHtml}${calendarButtonHtml}</div></div></div><div class="mt-4 space-y-2"><div class="flex items-center text-sm text-gray-500"><i class="ph-info mr-2"></i><p>${signup.description || ''}</p></div><div class="flex items-center text-sm text-gray-500"><i class="ph-calendar-blank mr-2"></i><p>${formatDate(signup.date)} at ${signup.time}</p></div><div class="flex items-center text-sm text-gray-500"><i class="ph-map-pin mr-2"></i><p>${signup.location}</p></div></div>`;
                    upcomingList.appendChild(item);
                });
            }
            if (pastSignups.length === 0) completedList.innerHTML = '<div class="bg-white p-4 rounded-lg shadow-sm text-gray-500">No completed or past signups.</div>';
            else {
                pastSignups.forEach(signup => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-6 rounded-lg shadow-sm';
                    const statusColor = signup.status === 'Completed' ? 'text-green-700 bg-green-100' : signup.status === 'Penalty' ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100';
                    item.innerHTML = `<div class="flex flex-col sm:flex-row justify-between"><div><h4 class="text-lg font-bold text-gray-900">${signup.title}</h4><p class="mt-2 text-sm text-gray-600">${signup.description || ''}</p><div class="mt-3 text-sm text-gray-500"><p><i class="ph-calendar-blank mr-1"></i> ${formatDate(signup.date)} at ${signup.time}</p></div></div><div class="mt-4 sm:mt-0 sm:ml-6 flex-shrink-0 text-left sm:text-right"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">${signup.status}</span></div></div>`;
                    completedList.appendChild(item);
                });
            }
        }

        // --- EVENT LISTENERS ---
       function addEventListeners() {
            document.body.addEventListener('click', function(event) {
                const target = event.target;
                const button = target.closest('button');

                if (button && button.matches('.withdraw-btn')) {
                    if (!confirm('Are you sure you want to withdraw from this event?')) return;
                    const signupId = button.dataset.signupId;
                    button.textContent = 'Withdrawing...';
                    button.disabled = true;
                    fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'withdraw', signupId: signupId, token: ID_TOKEN }),
                        headers: {'Content-Type': 'application/json'}
                    }).then(() => {
                        alert('Withdrawal successful! The portal will now refresh.');
                        fetchData(ID_TOKEN); 
                    }).catch(error => {
                        console.error('Withdrawal Error:', error);
                        alert(`An error occurred during withdrawal: Load failed`);
                        button.textContent = 'Withdraw';
                        button.disabled = false;
                    });
                }

                if (button && button.matches('.add-to-calendar-btn')) {
                    event.stopPropagation();
                    const dropdown = button.closest('.relative').querySelector('.event-dropdown');
                    if (dropdown) {
                        const eventData = { name: button.dataset.eventName, date: button.dataset.eventDate };
                        const googleLink = dropdown.querySelector('.google-cal-link');
                        const iCalLink = dropdown.querySelector('.ical-link');
                        googleLink.href = generateGoogleCalendarLink(eventData);
                        googleLink.target = "_blank";
                        iCalLink.href = generateICalLink(eventData);
                        iCalLink.download = `${eventData.name}.ics`;
                        dropdown.classList.toggle('hidden');
                    }
                } else {
                    document.querySelectorAll('.event-dropdown').forEach(dropdown => {
                        if (!dropdown.classList.contains('hidden')) dropdown.classList.add('hidden');
                    });
                }

                if (button && button.matches('.report-absence-nav-btn')) {
                    const studentId = button.dataset.studentId;
                    switchToTab('actions');
                    document.getElementById('student-select').value = studentId;
                }

                if (button && button.matches('.signup-btn')) {
                    const opportunityId = button.dataset.id;
                    button.textContent = 'Signing up...';
                    button.disabled = true;
                    fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'signup', opportunityId: opportunityId, token: ID_TOKEN }),
                        headers: {'Content-Type': 'application/json'}
                    }).then(() => {
                       alert('Signup successful! The portal will now refresh.');
                       fetchData(ID_TOKEN); 
                    }).catch(error => {
                        console.error('Signup Error:', error);
                        alert(`An error occurred during signup: Load failed`);
                        button.textContent = 'Sign Up';
                        button.disabled = false;
                    });
                }
                
                if (button && button.matches('#send-notification-btn')) {
                     button.textContent = 'Sending...';
                     button.disabled = true;
                    if (!portalData || !portalData.students) {
                        alert("Error: Student data has not loaded yet. Please wait.");
                        return;
                    }
                    const studentId = document.getElementById('student-select').value;
                    if (!studentId) {
                        alert("Please select a student.");
                        return;
                    }
                    const student = portalData.students.find(s => s.uniqueStudentId == studentId);
                    if (!student) {
                        alert(`Error: Could not find info for student ID ${studentId}.`);
                        return;
                    }
                    const reportType = document.querySelector('input[name="report-type"]:checked').value;
                    const startDate = document.getElementById('absence-start').value;
                    const endDate = document.getElementById('absence-end').value;
                    const tardyStartTime = document.getElementById('tardy-start-time').value;
                    const tardyEndTime = document.getElementById('tardy-end-time').value;
                    const reasonSelect = document.getElementById('absence-reason');
                    let reason = reasonSelect.value;
                    let comments = document.getElementById('absence-comments').value;
                    if (reason === 'Other') reason = document.getElementById('other-reason-text').value;
                    
                    fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            action: 'sendAbsenceEmail', 
                            student: student,
                            reportType, startDate, endDate, tardyStartTime, tardyEndTime, reason, comments,
                            token: ID_TOKEN 
                        })
                    })
                    .then(() => alert('Absence/Tardy notification sent successfully!'))
                    .catch(error => {
                        console.error('Email Send Error:', error);
                        alert(`An error occurred while sending the email: Load failed`);
                    })
                    .finally(() => {
                         button.textContent = 'Send Notification';
                         button.disabled = false;
                    });
                }

                if (button && button.matches('.show-qr-btn')) {
                    const signupId = button.dataset.signupId;
                    const qrCodeContainer = document.getElementById('qrcode');
                    qrCodeContainer.innerHTML = '';
                    const checkinUrl = `https://approve.svaportal.com/?signupId=${signupId}`;
                    const qr = qrcode(0, 'M');
                    qr.addData(checkinUrl);
                    qr.make();
                    qrCodeContainer.innerHTML = qr.createImgTag(6);
                    document.getElementById('qr-code-modal').classList.remove('hidden');
                }

                if (button && button.matches('#close-modal-btn')) {
                    document.getElementById('qr-code-modal').classList.add('hidden');
                }

                if (button && button.matches('.tab-btn')) {
                    switchToTab(button.dataset.tab);
                }
                
                if (button && button.matches('.faq-forms-tab-btn')) {
                    const tabName = button.dataset.tab;
                    document.querySelectorAll('.faq-forms-tab-btn').forEach(btn => {
                        btn.classList.remove('tab-active');
                        btn.classList.add('text-gray-500');
                    });
                    button.classList.add('tab-active');
                    button.classList.remove('text-gray-500');

                    document.querySelectorAll('.faq-forms-tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(tabName).classList.remove('hidden');
                }

                if (target.closest('#mobile-menu-button')) {
                    const mobileMenu = document.getElementById('mobile-menu');
                    const openIcon = document.getElementById('menu-icon-open');
                    const closeIcon = document.getElementById('menu-icon-close');
                    const isMenuOpen = mobileMenu.style.display === 'block';
                    mobileMenu.style.display = isMenuOpen ? 'none' : 'block';
                    openIcon.classList.toggle('hidden', !isMenuOpen);
                    closeIcon.classList.toggle('hidden', isMenuOpen);
                }

                if (button && button.matches('.volunteer-for-event-btn')) {
                    const eventId = button.dataset.eventId;
                    switchToTab('volunteering');
                    document.getElementById('filter-event').value = eventId;
                    applyAndRenderFilters();
                }

                if(target.matches('input[name="report-type"]')) {
                    const isTardy = target.value === 'tardy';
                    document.getElementById('tardy-fields').style.display = isTardy ? 'grid' : 'none';
                    document.getElementById('absence-fields').style.display = isTardy ? 'none' : 'grid';
                }

                if (button && button.matches('.show-more-events-btn')) {
                    const studentId = button.dataset.studentId;
                    const moreEventsDiv = document.getElementById(`more-events-${studentId}`);
                    if (moreEventsDiv) {
                        const isHidden = moreEventsDiv.classList.contains('hidden');
                        moreEventsDiv.classList.toggle('hidden');
                        button.textContent = isHidden ? 'Show Less' : 'Show More';
                    }
                }

                // NEW: Handles the volunteer event card collapse/expand ==================================================
                const header = target.closest('.volunteer-card-header');
                if (header) {
                        const targetId = header.dataset.target;
                        const content = document.getElementById(targetId);
                        const icon = header.querySelector('i');
                        if (content) {
                                content.classList.toggle('hidden');
                                icon.classList.toggle('rotate-180');
                        }
                }
            });

            const reasonSelect = document.getElementById('absence-reason');
            if (reasonSelect) {
                reasonSelect.addEventListener('change', function() {
                    const otherReasonContainer = document.getElementById('other-reason-container');
                    otherReasonContainer.style.display = (this.value === 'Other') ? 'block' : 'none';
                });
            }
            
            document.querySelectorAll('.filter-control').forEach(el => el.addEventListener('change', applyAndRenderFilters));
        }

        // --- INITIALIZATION ---

         window.onload = function() {
            try {
                google.accounts.id.initialize({
                  client_id: CLIENT_ID,
                  callback: handleCredentialResponse,
                  auto_select: true
                });
                google.accounts.id.renderButton(
                  document.getElementById('google-signin-button-container'),
                  { theme: "outline", size: "large" } 
                );
                
            } catch (error) {
                console.error("Google Sign-In initialization failed:", error);
                document.getElementById('login-screen').innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-lg text-red-600"><p>Could not initialize Google Sign-In. Please check your Client ID and that your website's URL is in the "Authorized JavaScript origins".</p></div>`;
            }
        };
    </script>
</body>
</html>
