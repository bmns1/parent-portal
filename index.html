<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silicon Valley Academy Parent Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-bottom: 2px solid #0d9488; /* teal-600 */
            color: #0d9488; /* teal-600 */
            background-color: #f0fdfa; /* teal-50 */
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        #mobile-menu { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Modal for QR Code -->
    <div id="qr-code-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Event Check-in QR Code</h3>
                <div class="mt-2 px-7 py-3">
                    <div id="qrcode" class="mx-auto"></div>
                    <p class="text-sm text-gray-500 mt-4">Have an admin scan this code when you arrive at the event to get credit for your hours.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-teal-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="min-h-screen bg-gray-100">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center">
                        <div class="flex-shrink-0"><i class="ph-graduation-cap text-4xl text-teal-600"></i></div>
                        <div class="ml-4">
                            <h1 class="text-2xl font-bold text-gray-800">Silicon Valley Academy</h1>
                            <p class="text-sm text-gray-500">Parent Portal</p>
                        </div>
                    </div>
                     <!-- Mobile menu button -->
                    <div class="sm:hidden flex items-center">
                        <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                            <span class="sr-only">Open main menu</span>
                            <i id="menu-icon-open" class="ph-list text-2xl"></i>
                            <i id="menu-icon-close" class="ph-x text-2xl hidden"></i>
                        </button>
                    </div>
                </div>
            </div>
             <!-- Mobile menu, show/hide based on menu state. -->
            <div class="sm:hidden" id="mobile-menu">
                <div id="main-nav-mobile" class="px-2 pt-2 pb-3 space-y-1">
                    <!-- Mobile nav links will be injected here -->
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="hidden sm:block bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="main-nav" class="flex justify-center -mb-px">
                    <button class="tab-btn tab-active text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="dashboard"><i class="ph-house mr-2"></i> Student Dashboard</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="actions"><i class="ph-bell-ringing mr-2"></i> Actions</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="volunteering"><i class="ph-hands-clapping mr-2"></i> Volunteering</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="signups"><i class="ph-list-checks mr-2"></i> My Signups</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="calendar"><i class="ph-calendar mr-2"></i> Calendar</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="links"><i class="ph-link mr-2"></i> Quick Links</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div id="dashboard" class="tab-content tab-content-active">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6">My Students</h2>
                <div id="student-content-container" class="space-y-12"></div>
            </div>
            
            <div id="actions" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Actions</h2>
                <div id="actions-content-container"></div>
            </div>

            <div id="volunteering" class="tab-content">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-6">Volunteering Opportunities</h2>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="filter-time" class="block text-sm font-medium text-gray-700">Time of Day</label>
                            <select id="filter-time" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                <option>All</option>
                                <option>Morning</option>
                                <option>Afternoon</option>
                                <option>Evening</option>
                                <option>All Day</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-hours" class="block text-sm font-medium text-gray-700">Max Hours</label>
                            <select id="filter-hours" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                <option value="99">Any</option>
                                <option value="2">Up to 2</option>
                                <option value="4">Up to 4</option>
                                <option value="8">Up to 8</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-location" class="block text-sm font-medium text-gray-700">Location</label>
                            <select id="filter-location" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                <option>All</option>
                                <option>On-Campus</option>
                                <option>Remote</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-sort" class="block text-sm font-medium text-gray-700">Sort By</label>
                            <select id="filter-sort" class="filter-control mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm">
                                <option value="default">Default</option>
                                <option value="recent">Recently Added</option>
                            </select>
                        </div>
                    </div>
                </div>
                 <div id="volunteering-list" class="space-y-6"><p>Loading volunteering opportunities...</p></div>
            </div>

            <div id="signups" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">My Volunteer Hours</h2>
                <div id="my-signups-content"></div>
            </div>

            <div id="calendar" class="tab-content">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-6">School Calendar</h2>
                 <div class="bg-white rounded-lg shadow overflow-hidden">
                    <iframe src="https://calendar.google.com/calendar/embed?src=svaschool.org_us4ga4j1cfs27epj0f2dfegcl0%40group.calendar.google.com&ctz=America/Los_Angeles" style="border: 0" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
                </div>
            </div>

            <div id="links" class="tab-content">
               <h2 class="text-2xl font-semibold text-gray-800 mb-6">Quick Links</h2>
                 <div class="bg-white p-6 rounded-lg shadow">
                    <ul class="space-y-3">
                        <li><a href="#" class="text-teal-600 hover:underline">School Website</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">District Website</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">Lunch Menus</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">Staff Directory</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">Athletics Schedule</a></li>
                    </ul>
                </div>
            </div>
        </main>
        
        <footer class="bg-white mt-12">
             <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-500"><p>&copy; 2025 Silicon Valley Academy. All Rights Reserved.</p></div>
        </footer>
    </div>
    
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxHyIbLz6SuXY-tccAqb_jZlmMSQteiS44TT8M43cZUefiVfUxHAXgL3v10rADfbu_o/exec';
        const PARENT_EMAIL = 'habiba@sva.org'; // Hardcoded for now
        let portalData = {}; // To store fetched data globally

        // --- HELPER FUNCTIONS ---
        function decodeGrade(grade) {
            const gradeStr = String(grade).toUpperCase();
            if (gradeStr === 'P') return 'Pre-K';
            if (gradeStr === '0') return 'KG';
            return `Grade ${gradeStr}`;
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date.toLocaleDateString();
            }
            return dateString;
        }
        function formatGoogleDate(date) {
            return date.toISOString().split('T')[0].replace(/-/g, '');
        }
        function generateICalLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nURL:${document.location.href}\nDTSTART;VALUE=DATE:${formatGoogleDate(startDate)}\nDTEND;VALUE=DATE:${formatGoogleDate(endDate)}\nSUMMARY:${event.name || event.title}\nDESCRIPTION:Event: ${event.name || event.title}\nLOCATION:Silicon Valley Academy\nEND:VEVENT\nEND:VCALENDAR`;
            return `data:text/calendar;charset=utf-8,${encodeURIComponent(icsContent)}`;
        }
        function generateGoogleCalendarLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const baseUrl = 'https://www.google.com/calendar/render?action=TEMPLATE';
            const title = `&text=${encodeURIComponent(event.name || event.title)}`;
            const dates = `&dates=${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
            const details = `&details=${encodeURIComponent('For more details, visit the school portal.')}`;
            const location = `&location=${encodeURIComponent('Silicon Valley Academy')}`;
            return `${baseUrl}${title}${dates}${details}${location}`;
        }
        function switchToTab(tabName) {
            const allTabs = document.querySelectorAll('.tab-btn');
            allTabs.forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active'));

            document.querySelectorAll(`.tab-btn[data-tab="${tabName}"]`).forEach(b => b.classList.add('tab-active'));
            document.getElementById(tabName).classList.add('tab-content-active');

            const mobileMenu = document.getElementById('mobile-menu');
            if(mobileMenu.style.display === 'block'){
                mobileMenu.style.display = 'none';
                document.getElementById('menu-icon-open').classList.remove('hidden');
                document.getElementById('menu-icon-close').classList.add('hidden');
            }
        }

        // --- DATA FETCH & RENDER ---
        function fetchData() {
            fetch(`${WEB_APP_URL}?parentEmail=${PARENT_EMAIL}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    portalData = data; 
                    renderDashboard(portalData.students);
                    renderActionsTab(portalData.students);
                    applyAndRenderFilters(); 
                    renderMySignups(portalData.mySignups, portalData.volunteerProgress);
                    renderMobileMenu();
                    if (typeof phosphor !== 'undefined') phosphor.replace();
                })
                .catch(error => { console.error('Fetch Error:', error); });
        }

        function renderDashboard(students) {
            const contentContainer = document.getElementById('student-content-container');
            contentContainer.innerHTML = ''; 

            if (!students || students.length === 0) {
                contentContainer.innerHTML = '<p class="text-center p-2 text-gray-500">No students found for this parent account.</p>';
                return;
            }
            
            students.forEach(student => {
                if (!student || !student.studentName) {
                    console.warn('Skipping invalid student record:', student);
                    contentContainer.innerHTML += `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert"><p class="font-bold">Data Issue</p><p>An incomplete student record was found. Please check your 'Students' Google Sheet for any blank rows and delete them.</p></div>`;
                    return;
                }

                const studentCard = document.createElement('div');
                
                let teachersHtml = (student.teachers && student.teachers.length > 0) ? student.teachers.map(teacher => `
                    <li class="flex items-center justify-between border-t pt-4">
                        <div class="flex items-center">
                            <img class="h-10 w-10 rounded-full mr-4" src="${teacher.photoUrl}" alt="${teacher.teacherName}">
                            <div><p class="font-semibold">${teacher.teacherName}</p><p class="text-sm text-gray-500">${teacher.role}</p></div>
                        </div>
                        <a href="mailto:${teacher.email}" class="text-teal-600 hover:underline text-sm">${teacher.email}</a>
                    </li>`).join('') : '<li class="text-gray-500">No teachers listed for this student.</li>';
                
                let eventsHtml = (student.events && student.events.length > 0) ? student.events.map((event, index) => {
                    const dropdownId = `event-dropdown-${student.uniqueStudentId}-${index}`;
                    return `
                        <li class="border-t pt-4 flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${event.name}</p>
                                <p class="text-sm text-gray-500">${formatDate(event.date)}</p>
                            </div>
                            <div class="relative inline-block text-left">
                                <div>
                                    <button type="button" class="add-to-calendar-btn inline-flex items-center justify-center w-full rounded-md border border-gray-300 shadow-sm px-3 py-1 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none" data-dropdown-id="${dropdownId}" data-event-name="${event.name}" data-event-date="${event.date}">
                                        <i class="ph-plus-circle mr-2"></i>
                                        Add
                                    </button>
                                </div>
                                <div id="${dropdownId}" class="event-dropdown origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu">
                                    <div class="py-1" role="none">
                                        <a href="#" class="google-cal-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Google Calendar</a>
                                        <a href="#" class="ical-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">iCal/Outlook</a>
                                    </div>
                                </div>
                            </div>
                        </li>`;
                }).join('') : '<li><p class="text-gray-500">No upcoming events for this student.</p></li>';
                
                const studentInitials = student.studentName.split(" ").map(n=>n[0]).join("");

                studentCard.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 mb-4">
                         <div class="flex items-center">
                            <img class="h-16 w-16 rounded-full" src="https://placehold.co/100x100/E2E8F0/4A5568?text=${studentInitials}" alt="Student Photo">
                            <div class="ml-4">
                                <h3 class="text-2xl font-bold text-gray-900">${student.studentName}</h3>
                                <p class="text-gray-600">${decodeGrade(student.grade)} - Classroom ${student.classroom}</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h4 class="font-semibold text-lg text-gray-700 mb-4">Quick Actions</h4>
                                 <button data-student-id="${student.uniqueStudentId}" class="report-absence-nav-btn inline-flex items-center bg-teal-100 text-teal-800 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200">Report an Absence for ${student.studentName}</button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                 <h4 class="font-semibold text-lg text-gray-700 mb-4">Teachers</h4>
                                 <ul class="space-y-4">${teachersHtml}</ul>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h4 class="font-semibold text-lg text-gray-700 mb-4">Upcoming Events for ${student.studentName}</h4>
                            <ul class="space-y-4">${eventsHtml}</ul>
                        </div>
                    </div>`;
                contentContainer.appendChild(studentCard);
            });
        }
        
        function renderMobileMenu() {
            const desktopNav = document.getElementById('main-nav');
            const mobileNavContainer = document.getElementById('main-nav-mobile');
            mobileNavContainer.innerHTML = ""; // Clear previous
            const buttons = desktopNav.querySelectorAll('.tab-btn');
            buttons.forEach(button => {
                const newBtn = button.cloneNode(true);
                newBtn.classList.remove('py-4', 'px-6');
                newBtn.classList.add('block', 'px-3', 'py-2', 'rounded-md', 'text-base', 'font-medium');
                mobileNavContainer.appendChild(newBtn);
            });
        }

        function renderActionsTab(students) {
            const container = document.getElementById('actions-content-container');
            
            if (!students || students.length === 0) {
                container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow"><p>No students found. Cannot report an absence.</p></div>`;
                return;
            }

            const studentOptions = students.map(student => `<option value="${student.uniqueStudentId}">${student.studentName}</option>`).join('');

            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow max-w-2xl mx-auto">
                    <h3 class="font-semibold text-lg text-gray-700 mb-4">Report an Absence</h3>
                    <div class="mb-4">
                        <label for="student-select" class="block text-sm font-medium text-gray-700">Select Student</label>
                        <select id="student-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            ${studentOptions}
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="absence-start" class="block text-sm font-medium text-gray-700">Absence Start Date</label>
                            <input type="date" id="absence-start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="absence-end" class="block text-sm font-medium text-gray-700">Absence End Date</label>
                            <input type="date" id="absence-end" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="absence-reason" class="block text-sm font-medium text-gray-700">Reason for Absence</label>
                        <select id="absence-reason" class="absence-reason-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option>Sick</option>
                            <option>Travel</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div id="other-reason-container" class="mb-4" style="display: none;">
                        <label for="other-reason-text" class="block text-sm font-medium text-gray-700">Please specify:</label>
                        <textarea id="other-reason-text" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                    </div>
                    <button id="generate-absence-email-btn" class="inline-flex items-center bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700">Generate Absence Email</button>
                    <p class="text-xs text-gray-500 mt-2">This will open your default email client with a pre-filled message addressed to the attendance office and the selected student's teachers.</p>
                </div>
            `;
        }

        function renderVolunteering(opportunities) {
             const list = document.getElementById('volunteering-list');
            list.innerHTML = '';
            if (!opportunities || opportunities.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 bg-white p-6 rounded-lg shadow">No volunteering opportunities match your current filters.</div>';
                return;
            }
            opportunities.forEach(opp => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow transition hover:shadow-lg';
                card.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${opp.title}</h3>
                            <p class="mt-2 text-gray-600">${opp.description}</p>
                            <div class="mt-4 flex flex-col sm:flex-row sm:items-center text-sm text-gray-500 space-y-2 sm:space-y-0 sm:space-x-4">
                                <span><i class="ph-calendar-blank mr-1"></i> ${formatDate(opp.date)}</span>
                                <span><i class="ph-clock mr-1"></i> ${opp.time}</span>
                                <span><i class="ph-map-pin mr-1"></i> ${opp.location}</span>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0 md:ml-6 flex-shrink-0 text-right">
                            <p class="text-sm text-gray-600 mb-2" id="spots-${opp.id}">${opp.signedUp} of ${opp.needed} spots filled</p>
                            <button data-id="${opp.id}" class="signup-btn w-full md:w-auto bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition">Sign Up</button>
                        </div>
                    </div>`;
                list.appendChild(card);
            });
        }
        
        function applyAndRenderFilters() {
            if (!portalData.volunteering || !document.getElementById('filter-time')) {
                if(portalData.volunteering) renderVolunteering(portalData.volunteering);
                return;
            }

            let filteredOpportunities = [...portalData.volunteering];

            // Get current filter values
            const timeFilter = document.getElementById('filter-time').value;
            const hoursFilter = parseInt(document.getElementById('filter-hours').value, 10);
            const locationFilter = document.getElementById('filter-location').value;
            const sortFilter = document.getElementById('filter-sort').value;

            // Apply filters
            if (timeFilter !== 'All') {
                filteredOpportunities = filteredOpportunities.filter(opp => opp.timeOfDay === timeFilter);
            }
            if (hoursFilter !== 99) {
                filteredOpportunities = filteredOpportunities.filter(opp => opp.hours <= hoursFilter);
            }
            if (locationFilter !== 'All') {
                filteredOpportunities = filteredOpportunities.filter(opp => opp.locationType === locationFilter);
            }

            // Apply sorting
            if (sortFilter === 'recent') {
                filteredOpportunities.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            }
            
            renderVolunteering(filteredOpportunities);
        }

        function renderMySignups(signups, progress) {
            const mySignupsContainer = document.getElementById('my-signups-content');
            mySignupsContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h3 class="text-lg font-semibold text-gray-800">Your Progress</h3>
                    <div class="mt-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-teal-700">Completed Hours</span>
                            <span class="text-sm font-medium text-teal-700" id="progress-text">0 of 0 hours</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 relative">
                            <div id="progress-bar-inprogress" class="bg-orange-400 h-4 rounded-full" style="width: 0%"></div>
                            <div id="progress-bar-completed" class="bg-teal-600 h-4 rounded-full absolute top-0 left-0" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                             <span id="in-progress-text">0 hours in progress</span>
                             <span id="penalty-text" class="text-red-600 font-semibold"></span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Upcoming Signups (In Progress)</h3>
                        <p class="text-sm text-gray-600 mb-4">You may withdraw from an event up to 3 weeks (21 days) before the event date.</p>
                        <div id="upcoming-signups-list" class="space-y-4"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Completed & Past Signups</h3>
                        <div id="completed-signups-list" class="space-y-4"></div>
                    </div>
                </div>
            `;
            
            const upcomingList = document.getElementById('upcoming-signups-list');
            const completedList = document.getElementById('completed-signups-list');
            const completedBar = document.getElementById('progress-bar-completed');
            const inProgressBar = document.getElementById('progress-bar-inprogress');
            const progressText = document.getElementById('progress-text');
            const inProgressText = document.getElementById('in-progress-text');
            const penaltyText = document.getElementById('penalty-text');

            if (progress) {
                const completedPercentage = (progress.completed / progress.totalRequired) * 100;
                const inProgressPercentage = (progress.inProgress / progress.totalRequired) * 100;
                
                completedBar.style.width = `${Math.min(completedPercentage, 100)}%`;
                inProgressBar.style.width = `${Math.min(completedPercentage + inProgressPercentage, 100)}%`;
                
                progressText.textContent = `${progress.completed} of ${progress.totalRequired} hours`;
                inProgressText.textContent = `${progress.inProgress || 0} hours in progress`;
                penaltyText.textContent = progress.penalty > 0 ? `+ ${progress.penalty} penalty hours` : '';
            }

            const upcomingSignups = signups.filter(s => s.status === 'In Progress');
            const pastSignups = signups.filter(s => s.status === 'Completed' || s.status === 'Penalty' || s.status === 'Withdrawn');

            if (upcomingSignups.length === 0) {
                upcomingList.innerHTML = '<div class="bg-white p-4 rounded-lg shadow-sm text-gray-500">No upcoming volunteer signups.</div>';
            } else {
                upcomingSignups.forEach((signup, index) => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-6 rounded-lg shadow-sm';
                    
                    const eventDate = new Date(signup.date);
                    const today = new Date();
                    const daysUntilEvent = (eventDate - today) / (1000 * 60 * 60 * 24);
                    
                    let withdrawButtonHtml = '';
                    if (daysUntilEvent > 21) {
                        withdrawButtonHtml = `<button data-signup-id="${signup.signupId}" class="withdraw-btn w-full text-sm bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition">Withdraw</button>`;
                    } else {
                        withdrawButtonHtml = `<button class="w-full text-sm bg-gray-200 text-gray-500 font-semibold py-2 px-4 rounded-lg cursor-not-allowed" disabled>Withdrawal period has passed</button>`;
                    }

                    const qrButtonHtml = `<button data-signup-id="${signup.signupId}" class="show-qr-btn w-full text-sm bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition">Show Check-in Code</button>`;
                    
                    const dropdownId = `signup-cal-dropdown-${index}`;
                    const calendarButtonHtml = `
                        <div class="relative">
                            <button type="button" class="add-to-calendar-btn w-full inline-flex items-center justify-center rounded-md border border-gray-300 shadow-sm px-3 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none" data-dropdown-id="${dropdownId}" data-event-name="${signup.title}" data-event-date="${signup.date}">
                                <i class="ph-plus-circle mr-2"></i> Add
                            </button>
                            <div id="${dropdownId}" class="event-dropdown origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu">
                                <div class="py-1" role="none">
                                    <a href="#" class="google-cal-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Google Calendar</a>
                                    <a href="#" class="ical-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">iCal/Outlook</a>
                                </div>
                            </div>
                        </div>`;

                    item.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between">
                            <div class="flex-grow">
                                <h4 class="text-lg font-bold text-gray-900">${signup.title}</h4>
                                <div class="mt-4 space-y-2">
                                    <div class="flex items-center text-sm text-gray-500">
                                        <i class="ph-info mr-2"></i>
                                        <p>${signup.description || ''}</p>
                                    </div>
                                    <div class="flex items-center text-sm text-gray-500">
                                        <i class="ph-calendar-blank mr-2"></i>
                                        <p>${formatDate(signup.date)} at ${signup.time}</p>
                                    </div>
                                    <div class="flex items-center text-sm text-gray-500">
                                        <i class="ph-map-pin mr-2"></i>
                                        <p>${signup.location}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 sm:mt-0 sm:ml-6 flex-shrink-0 flex flex-col space-y-2 w-full sm:w-48">
                                ${qrButtonHtml}
                                ${withdrawButtonHtml}
                                ${calendarButtonHtml}
                            </div>
                        </div>
                    `;
                    upcomingList.appendChild(item);
                });
            }

            if (pastSignups.length === 0) {
                completedList.innerHTML = '<div class="bg-white p-4 rounded-lg shadow-sm text-gray-500">No completed or past signups.</div>';
            } else {
                pastSignups.forEach(signup => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-6 rounded-lg shadow-sm';
                    const statusColor = signup.status === 'Completed' ? 'text-green-700 bg-green-100' : 
                                        signup.status === 'Penalty' ? 'text-red-700 bg-red-100' : 
                                        'text-gray-700 bg-gray-100';
                    item.innerHTML = `
                         <div class="flex flex-col sm:flex-row justify-between">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">${signup.title}</h4>
                                <p class="mt-2 text-sm text-gray-600">${signup.description || ''}</p>
                                <div class="mt-3 text-sm text-gray-500">
                                    <p><i class="ph-calendar-blank mr-1"></i> ${formatDate(signup.date)} at ${signup.time}</p>
                                </div>
                            </div>
                            <div class="mt-4 sm:mt-0 sm:ml-6 flex-shrink-0 text-left sm:text-right">
                                 <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">${signup.status}</span>
                            </div>
                        </div>
                    `;
                    completedList.appendChild(item);
                });
            }
        }

        // --- EVENT LISTENERS ---
        function addEventListeners() {
            document.body.addEventListener('click', function(event) {
                const target = event.target;

                // Withdraw button
                if (target.matches('.withdraw-btn')) {
                    if (!confirm('Are you sure you want to withdraw from this event?')) return;
                    const button = target;
                    const signupId = button.dataset.signupId;
                    button.textContent = 'Withdrawing...';
                    button.disabled = true;

                    fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'withdraw', signupId: signupId, parentEmail: PARENT_EMAIL })
                    })
                    .then(() => {
                       alert('Withdrawal successful! The portal will now refresh.');
                       fetchData(); 
                    })
                    .catch(error => {
                        console.error('Withdrawal Error:', error);
                        alert(`An error occurred during withdrawal.`);
                        button.textContent = 'Withdraw';
                        button.disabled = false;
                    });
                }

                // Add to Calendar dropdown button
                if (target.closest('.add-to-calendar-btn')) {
                    event.stopPropagation();
                    const button = target.closest('.add-to-calendar-btn');
                    const dropdown = button.closest('.relative').querySelector('.event-dropdown');
                    
                    if (dropdown) {
                        const eventData = {
                            name: button.dataset.eventName,
                            date: button.dataset.eventDate
                        };
                        const googleLink = dropdown.querySelector('.google-cal-link');
                        const iCalLink = dropdown.querySelector('.ical-link');
                        
                        googleLink.href = generateGoogleCalendarLink(eventData);
                        googleLink.target = "_blank";
                        iCalLink.href = generateICalLink(eventData);
                        iCalLink.download = `${eventData.name}.ics`;

                        dropdown.classList.toggle('hidden');
                    }
                } else {
                    document.querySelectorAll('.event-dropdown').forEach(dropdown => {
                        if (!dropdown.classList.contains('hidden')) {
                           dropdown.classList.add('hidden');
                        }
                    });
                }

                // Report Absence navigation button
                if (target.matches('.report-absence-nav-btn')) {
                    const studentId = target.dataset.studentId;
                    switchToTab('actions');
                    document.getElementById('student-select').value = studentId;
                }

                // Volunteer signup button
                if (target.matches('.signup-btn')) {
                    const button = target;
                    const opportunityId = button.dataset.id;
                    button.textContent = 'Signing up...';
                    button.disabled = true;

                    fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'signup', opportunityId: opportunityId, parentEmail: PARENT_EMAIL })
                    })
                    .then(() => {
                       alert('Signup successful! The portal will now refresh to show your updated signups.');
                       fetchData(); 
                    })
                    .catch(error => {
                        console.error('Signup Error:', error);
                        alert('An error occurred during signup.');
                        button.textContent = 'Sign Up';
                        button.disabled = false;
                    });
                }
                
                // Generate Absence Email button
                if (target.matches('#generate-absence-email-btn')) {
                    if (!portalData || !portalData.students) {
                        alert("Error: Student data has not loaded yet. Please wait a moment and try again.");
                        return;
                    }

                    const studentId = document.getElementById('student-select').value;
                    if (!studentId) {
                        alert("Please select a student.");
                        return;
                    }

                    const student = portalData.students.find(s => s.uniqueStudentId === studentId);
                    
                    if (!student) {
                        alert(`Error: Could not find information for student ID ${studentId}.`);
                        return;
                    }

                    const startDate = document.getElementById('absence-start').value;
                    if (!startDate) {
                        alert('Please select an absence start date.');
                        return;
                    }
                    
                    const endDate = document.getElementById('absence-end').value;
                    const reasonSelect = document.getElementById('absence-reason');
                    let reason = reasonSelect.value;
                    
                    if (reason === 'Other') {
                        reason = document.getElementById('other-reason-text').value;
                    }

                    const attendanceEmail = 'attendance@siliconvalleyacademy.com';
                    const teacherEmails = student.teachers.map(t => t.email).join(',');
                    const recipients = teacherEmails ? `${attendanceEmail},${teacherEmails}` : attendanceEmail;
                    
                    const subject = `Absence Notification for ${student.studentName} (Grade: ${student.grade} - Class: ${student.classroom})`;
                    const body = `Dear SVA Staff,\n\nPlease be advised that my child, ${student.studentName}, will be absent.\n\nStudent: ${student.studentName}\nGrade: ${decodeGrade(student.grade)}\nClassroom: ${student.classroom}\n\nStart Date: ${startDate}\nEnd Date: ${endDate || startDate}\n\nReason: ${reason}\n\nThank you,\n${PARENT_EMAIL}`;
                    
                    window.location.href = `mailto:${recipients}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                }

                // Show QR Code button
                if (target.matches('.show-qr-btn')) {
                    const signupId = target.dataset.signupId;
                    const qrCodeContainer = document.getElementById('qrcode');
                    qrCodeContainer.innerHTML = ''; // Clear previous QR code
                    
                    const checkinUrl = `https://bmns1.github.io/checkin/?signupId=${signupId}`;
                    const qr = qrcode(0, 'M');
                    qr.addData(checkinUrl);
                    qr.make();
                    qrCodeContainer.innerHTML = qr.createImgTag(6); // size 6

                    document.getElementById('qr-code-modal').classList.remove('hidden');
                }

                if (target.matches('#close-modal-btn')) {
                    document.getElementById('qr-code-modal').classList.add('hidden');
                }


                // Main nav tabs (desktop and mobile)
                if (target.closest('.tab-btn')) {
                    switchToTab(target.closest('.tab-btn').dataset.tab);
                }

                // Mobile menu toggle
                if (target.closest('#mobile-menu-button')) {
                    const mobileMenu = document.getElementById('mobile-menu');
                    const openIcon = document.getElementById('menu-icon-open');
                    const closeIcon = document.getElementById('menu-icon-close');
                    const isMenuOpen = mobileMenu.style.display === 'block';
                    mobileMenu.style.display = isMenuOpen ? 'none' : 'block';
                    openIcon.classList.toggle('hidden', !isMenuOpen);
                    closeIcon.classList.toggle('hidden', isMenuOpen);
                }
            });

            // Other non-click listeners
            const reasonSelect = document.getElementById('absence-reason');
            if (reasonSelect) {
                reasonSelect.addEventListener('change', function() {
                    const otherReasonContainer = document.getElementById('other-reason-container');
                    otherReasonContainer.style.display = (this.value === 'Other') ? 'block' : 'none';
                });
            }
            
            document.querySelectorAll('.filter-control').forEach(el => {
                el.addEventListener('change', applyAndRenderFilters);
            });
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            fetchData();
            addEventListeners();
        };
    </script>
</body>
</html>
