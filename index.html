<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- IMPORTANT: Replace with your actual Google Client ID -->
    <meta name="google-signin-client_id" content="14216824305-v19ecsmrhk1muaglrlhjceqjk5oeqr4n.apps.googleusercontent.com">
    <title>Silicon Valley Academy Parent Portal</title>
    <script src="https://apis.google.com/js/platform.js?onload=startApp" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-bottom: 2px solid #0d9488; /* teal-600 */
            color: #0d9488; /* teal-600 */
            background-color: #f0fdfa; /* teal-50 */
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        #mobile-menu { display: none; }
    </style>
</head>
<body class="antialiased">

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="text-center p-8 bg-white rounded-lg shadow-lg">
            <i class="ph-graduation-cap text-6xl text-teal-600 mx-auto"></i>
            <h1 class="text-3xl font-bold text-gray-800 mt-4">Silicon Valley Academy</h1>
            <p class="text-lg text-gray-600 mb-8">Parent Portal</p>
            <div id="my-signin2"></div>
        </div>
    </div>

    <div id="portal-main-content" class="min-h-screen bg-gray-100 hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center">
                        <div class="flex-shrink-0"><i class="ph-graduation-cap text-4xl text-teal-600"></i></div>
                        <div class="ml-4">
                            <h1 class="text-2xl font-bold text-gray-800">Silicon Valley Academy</h1>
                            <p class="text-sm text-gray-500">Parent Portal</p>
                        </div>
                    </div>
                     <!-- Mobile menu button -->
                    <div class="sm:hidden flex items-center">
                         <div id="user-info-mobile" class="mr-4 text-right"></div>
                        <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                            <span class="sr-only">Open main menu</span>
                            <i id="menu-icon-open" class="ph-list text-2xl"></i>
                            <i id="menu-icon-close" class="ph-x text-2xl hidden"></i>
                        </button>
                    </div>
                    <div class="hidden sm:flex items-center">
                        <div id="user-info-desktop" class="mr-4 text-right"></div>
                        <button onclick="signOut();" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Sign Out</button>
                    </div>
                </div>
            </div>
             <!-- Mobile menu, show/hide based on menu state. -->
            <div class="sm:hidden" id="mobile-menu">
                <div id="main-nav-mobile" class="px-2 pt-2 pb-3 space-y-1">
                    <!-- Mobile nav links will be injected here -->
                </div>
                 <div class="pt-4 pb-3 border-t border-gray-200">
                    <div class="px-2">
                         <button onclick="signOut();" class="w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="hidden sm:block bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="main-nav" class="flex justify-center -mb-px">
                    <button class="tab-btn tab-active text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="dashboard"><i class="ph-house mr-2"></i> Student Dashboard</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="actions"><i class="ph-bell-ringing mr-2"></i> Actions</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="volunteering"><i class="ph-hands-clapping mr-2"></i> Volunteering</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="signups"><i class="ph-list-checks mr-2"></i> My Signups</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="calendar"><i class="ph-calendar mr-2"></i> Calendar</button>
                    <button class="tab-btn text-gray-600 hover:text-teal-600 py-4 px-6 block hover:text-teal-500 focus:outline-none" data-tab="links"><i class="ph-link mr-2"></i> Quick Links</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div id="dashboard" class="tab-content tab-content-active">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6">My Students</h2>
                <div id="student-content-container" class="space-y-12"></div>
            </div>
            
            <div id="actions" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Actions</h2>
                <div id="actions-content-container"></div>
            </div>

            <div id="volunteering" class="tab-content">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-6">Volunteering Opportunities</h2>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <!-- Filter Controls -->
                </div>
                 <div id="volunteering-list" class="space-y-6"><p>Loading volunteering opportunities...</p></div>
            </div>

            <div id="signups" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">My Volunteer Hours</h2>
                <div id="my-signups-content"></div>
            </div>

            <div id="calendar" class="tab-content">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-6">School Calendar</h2>
                 <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6"><p class="text-center text-gray-600">Consider embedding a live Google Calendar for up-to-date information.</p></div>
                    <img src="https://placehold.co/1200x600/E2E8F0/4A5568?text=Embedded+Calendar+Goes+Here" alt="Calendar Placeholder" class="w-full h-auto">
                </div>
            </div>

            <div id="links" class="tab-content">
               <h2 class="text-2xl font-semibold text-gray-800 mb-6">Quick Links</h2>
                 <div class="bg-white p-6 rounded-lg shadow">
                    <ul class="space-y-3">
                        <li><a href="#" class="text-teal-600 hover:underline">School Website</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">District Website</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">Lunch Menus</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">Staff Directory</a></li>
                        <li><a href="#" class="text-teal-600 hover:underline">Athletics Schedule</a></li>
                    </ul>
                </div>
            </div>
        </main>
        
        <footer class="bg-white mt-12">
             <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-500"><p>&copy; 2025 Silicon Valley Academy. All Rights Reserved.</p></div>
        </footer>
    </div>
    
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxHyIbLz6SuXY-tccAqb_jZlmMSQteiS44TT8M43cZUefiVfUxHAXgL3v10rADfbu_o/exec';
        let PARENT_EMAIL = ''; // Will be set on login
        let portalData = {}; // To store fetched data globally

        // --- GOOGLE SIGN-IN ---
        function onSignIn(googleUser) {
            const profile = googleUser.getBasicProfile();
            PARENT_EMAIL = profile.getEmail();
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('portal-main-content').classList.remove('hidden');

            const userInfoHtml = `
                <div class="flex items-center">
                    <img class="h-8 w-8 rounded-full" src="${profile.getImageUrl()}" alt="">
                    <div class="ml-3">
                        <div class="text-base font-medium text-gray-800">${profile.getName()}</div>
                        <div class="text-sm font-medium text-gray-500">${profile.getEmail()}</div>
                    </div>
                </div>`;
            document.getElementById('user-info-desktop').innerHTML = userInfoHtml;
            document.getElementById('user-info-mobile').innerHTML = userInfoHtml;

            fetchData(PARENT_EMAIL);
        }

        function signOut() {
            const auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
                window.location.reload();
            });
        }

        function renderGoogleButton() {
            gapi.signin2.render('my-signin2', {
                'scope': 'profile email',
                'width': 240,
                'height': 50,
                'longtitle': true,
                'theme': 'dark',
                'onsuccess': onSignIn,
            });
        }
        
        // --- HELPER FUNCTIONS ---
        function decodeGrade(grade) {
            const gradeStr = String(grade).toUpperCase();
            if (gradeStr === 'P') return 'Pre-K';
            if (gradeStr === '0') return 'KG';
            return `Grade ${gradeStr}`;
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return date.toLocaleDateString();
            }
            return dateString;
        }
        function formatGoogleDate(date) {
            return date.toISOString().split('T')[0].replace(/-/g, '');
        }
        function generateICalLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nURL:${document.location.href}\nDTSTART;VALUE=DATE:${formatGoogleDate(startDate)}\nDTEND;VALUE=DATE:${formatGoogleDate(endDate)}\nSUMMARY:${event.name}\nDESCRIPTION:Event: ${event.name}\nLOCATION:Silicon Valley Academy\nEND:VEVENT\nEND:VCALENDAR`;
            return `data:text/calendar;charset=utf-8,${encodeURIComponent(icsContent)}`;
        }
        function generateGoogleCalendarLink(event) {
            const startDate = new Date(event.date);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 1);
            const baseUrl = 'https://www.google.com/calendar/render?action=TEMPLATE';
            const title = `&text=${encodeURIComponent(event.name)}`;
            const dates = `&dates=${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
            const details = `&details=${encodeURIComponent('For more details, visit the school portal.')}`;
            const location = `&location=${encodeURIComponent('Silicon Valley Academy')}`;
            return `${baseUrl}${title}${dates}${details}${location}`;
        }
        function switchToTab(tabName) {
            const allTabs = document.querySelectorAll('.tab-btn');
            allTabs.forEach(btn => btn.classList.remove('tab-active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active'));

            document.querySelectorAll(`.tab-btn[data-tab="${tabName}"]`).forEach(b => b.classList.add('tab-active'));
            document.getElementById(tabName).classList.add('tab-content-active');

            const mobileMenu = document.getElementById('mobile-menu');
            if(mobileMenu.style.display === 'block'){
                mobileMenu.style.display = 'none';
                document.getElementById('menu-icon-open').classList.remove('hidden');
                document.getElementById('menu-icon-close').classList.add('hidden');
            }
        }

        // --- DATA FETCH & RENDER ---
        function fetchData(parentEmail) {
            fetch(`${WEB_APP_URL}?parentEmail=${parentEmail}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    portalData = data; 
                    renderDashboard(portalData.students);
                    renderActionsTab(portalData.students);
                    applyAndRenderFilters(); 
                    renderMySignups(portalData.mySignups, portalData.volunteerProgress);
                    renderMobileMenu();
                    if (typeof phosphor !== 'undefined') phosphor.replace();
                })
                .catch(error => { console.error('Fetch Error:', error); });
        }

        function renderDashboard(students) {
            const contentContainer = document.getElementById('student-content-container');
            contentContainer.innerHTML = ''; 

            if (!students || students.length === 0) {
                contentContainer.innerHTML = '<p class="text-center p-2 text-gray-500">No students found for this parent account.</p>';
                return;
            }
            
            students.forEach(student => {
                if (!student || !student.studentName) {
                    console.warn('Skipping invalid student record:', student);
                    return;
                }
                const studentCard = document.createElement('div');
                
                let teachersHtml = (student.teachers && student.teachers.length > 0) ? student.teachers.map(teacher => `...`).join('') : '...';
                let eventsHtml = (student.events && student.events.length > 0) ? student.events.map((event, index) => `...`).join('') : '...';
                const studentInitials = student.studentName.split(" ").map(n=>n[0]).join("");

                studentCard.innerHTML = `...`; // Abridged for clarity
                contentContainer.appendChild(studentCard);
            });
        }
        
        function renderMobileMenu() { /* ... */ }
        function renderActionsTab(students) { /* ... */ }
        function renderVolunteering(opportunities) { /* ... */ }
        function applyAndRenderFilters() { /* ... */ }
        function renderMySignups(signups, progress) {
            document.getElementById('my-signups-content').innerHTML = `...`; // Abridged
        }

        // --- EVENT LISTENERS ---
        function addEventListeners() {
            document.body.addEventListener('click', function(event) {
                const target = event.target;
                
                if (target.matches('.withdraw-btn')) { /* ... */ }
                if (target.closest('.add-to-calendar-btn')) { /* ... */ }
                if (target.matches('.report-absence-nav-btn')) { /* ... */ }
                if (target.matches('.signup-btn')) { /* ... */ }
                if (target.matches('#generate-absence-email-btn')) { /* ... */ }
                if (target.closest('.tab-btn')) { /* ... */ }
                if (target.closest('#mobile-menu-button')) { /* ... */ }
            });

            const reasonSelect = document.getElementById('absence-reason');
            if (reasonSelect) {
                reasonSelect.addEventListener('change', function() {
                    const otherReasonContainer = document.getElementById('other-reason-container');
                    otherReasonContainer.style.display = (this.value === 'Other') ? 'block' : 'none';
                });
            }
            
            document.querySelectorAll('.filter-control').forEach(el => {
                el.addEventListener('change', applyAndRenderFilters);
            });
        }

        // --- INITIALIZATION ---
        function startApp() {
            gapi.load('auth2', function(){
                gapi.auth2.init({
                    client_id: document.querySelector('meta[name="google-signin-client_id"]').content
                }).then(function(){
                    renderGoogleButton();
                    addEventListeners(); // Add all listeners once the app starts
                }).catch(function(error) {
                    console.error('Google Auth Init Error:', JSON.stringify(error, undefined, 2));
                    alert('Could not initialize Google Sign-In. Please check your Client ID and ensure you have configured the OAuth consent screen in the Google Cloud Console.');
                });
            });
        }
    </script>
</body>
</html>
